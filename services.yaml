apiVersion: codex-k8s.dev/v1alpha1
kind: ServiceStack
metadata:
  name: codex-k8s
spec:
  project: codex-k8s
  projectDocs:
    - path: README.md
      description: Обзор платформы, роли агентов, сценарии использования и пошаговый workflow от Issue до деплоя.
    - path: AGENTS.md
      description: Обязательные правила для ИИ-агентов в этом репозитории.
    - path: docs/design-guidelines
      description: Стандарты проектирования и чек-листы разработки (Go/Vue/Common).
      roles: [dev, reviewer, qa, sa, em, km, sre]
    - path: docs/product
      description: Продуктовая модель этапов, ролей, лейблов и операционных политик.
      roles: [dev, pm, sa, em, km, reviewer]
    - path: docs/architecture
      description: Архитектурные контракты, C4, RBAC, transport boundary и prompt policy.
      roles: [sa, dev, reviewer, km, sre]
    - path: docs/ops
      description: Production runbook и эксплуатационные процедуры платформы.
      roles: [sre, em, dev]
    - path: docs/delivery
      description: Планы спринтов/эпиков, трассируемость и критерии готовности.
      roles: [em, pm, km, reviewer]
  versions:
    api-gateway:
      value: "0.1.3"
      bumpOn:
        - services/external/api-gateway
        - libs/go
        - proto
    control-plane:
      value: "0.1.9"
      bumpOn:
        - services/internal/control-plane
        - libs/go
        - proto
    worker:
      value: "0.1.5"
      bumpOn:
        - services/jobs/worker
        - libs/go
        - proto
    agent-runner:
      value: "0.1.1"
      bumpOn:
        - services/jobs/agent-runner
        - libs/go
        - proto
    web-console:
      value: "0.1.2"
      bumpOn:
        - services/staff/web-console
        - libs/ts
        - libs/vue
    alpine-git:
      value: "2.47.2"
    kaniko-executor:
      value: "v1.23.2-debug"
    busybox:
      value: "1.36"
    pgvector:
      value: "pg16"
    oauth2-proxy:
      value: "v7.6.0"
    golang-alpine:
      value: "1.25.6-alpine"
    golang-bookworm:
      value: "1.25.6-bookworm"
    golang-codegen:
      value: "1.24-bookworm"
    node-alpine:
      value: "22-alpine"
    node-bookworm:
      value: "22-bookworm"
    nginx-alpine:
      value: "1.27-alpine"
    kubectl:
      value: "v1.32.2"
  components:
    - name: hot-reload-defaults
      serviceDefaults:
        # production is prod-like. Hot-reload is only supported in ai slots.
        codeUpdateStrategy: '{{ ternary (eq .Env "ai") "hot-reload" "restart" }}'
  environments:
    dev:
      namespaceTemplate: "{{ .Project }}-dev"
    production:
      namespaceTemplate: "{{ .Project }}-prod"
    ai:
      from: production
      namespaceTemplate: "{{ .Project }}-dev-{{ .Slot }}"
    ai-repair:
      from: production
      namespaceTemplate: "{{ .Project }}-prod"
  webhookRuntime:
    defaultMode: full-env
    triggerModes:
      intake: code-only
      intake_revise: code-only
      vision: code-only
      vision_revise: code-only
      prd: code-only
      prd_revise: code-only
      self_improve: code-only
  secretResolution:
    environmentAliases:
      production: [prod]
    keyOverrides:
      - sourceKey: CODEXK8S_GITHUB_OAUTH_CLIENT_ID
        overrideKeys:
          ai: CODEXK8S_GITHUB_OAUTH_CLIENT_ID_AI
          production: CODEXK8S_PRODUCTION_GITHUB_OAUTH_CLIENT_ID
      - sourceKey: CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET
        overrideKeys:
          ai: CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET_AI
          production: CODEXK8S_PRODUCTION_GITHUB_OAUTH_CLIENT_SECRET
    patterns:
      - sourcePrefix: CODEXK8S_
        excludeSuffixes:
          - _AI
        environments:
          - ai
        overrideTemplate: "{key}_{env_upper}"
  images:
    kaniko-clone:
      type: external
      from: 'alpine/git:{{ index .Versions "alpine-git" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/alpine-git:{{ index .Versions "alpine-git" }}'
    kaniko-executor:
      type: external
      from: 'gcr.io/kaniko-project/executor:{{ index .Versions "kaniko-executor" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/kaniko-executor:{{ index .Versions "kaniko-executor" }}'
    repo-sync:
      type: external
      from: 'alpine/git:{{ index .Versions "alpine-git" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/alpine-git:{{ index .Versions "alpine-git" }}'
    busybox:
      type: external
      from: 'busybox:{{ index .Versions "busybox" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/busybox:{{ index .Versions "busybox" }}'
    postgres:
      type: external
      from: 'pgvector/pgvector:{{ index .Versions "pgvector" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/pgvector:{{ index .Versions "pgvector" }}'
    oauth2-proxy:
      type: external
      from: 'quay.io/oauth2-proxy/oauth2-proxy:{{ index .Versions "oauth2-proxy" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/oauth2-proxy:{{ index .Versions "oauth2-proxy" }}'
    codegen-check:
      type: external
      from: 'golang:{{ index .Versions "golang-codegen" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:{{ index .Versions "golang-codegen" }}'
    golang-alpine:
      type: external
      from: 'golang:{{ index .Versions "golang-alpine" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:{{ index .Versions "golang-alpine" }}'
    golang-bookworm:
      type: external
      from: 'golang:{{ index .Versions "golang-bookworm" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:{{ index .Versions "golang-bookworm" }}'
    node-alpine:
      type: external
      from: 'node:{{ index .Versions "node-alpine" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/node:{{ index .Versions "node-alpine" }}'
    node-bookworm:
      type: external
      from: 'node:{{ index .Versions "node-bookworm" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/node:{{ index .Versions "node-bookworm" }}'
    nginx-alpine:
      type: external
      from: 'nginx:{{ index .Versions "nginx-alpine" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/nginx:{{ index .Versions "nginx-alpine" }}'
    kubectl:
      type: external
      from: 'registry.k8s.io/kubectl:{{ index .Versions "kubectl" }}'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/kubectl:{{ index .Versions "kubectl" }}'
    api-gateway:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/api-gateway" }}'
      tagTemplate: '{{ .Env }}-{{ index .Versions "api-gateway" }}'
      dockerfile: services/external/api-gateway/Dockerfile
      context: .
    control-plane:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/control-plane" }}'
      tagTemplate: '{{ .Env }}-{{ index .Versions "control-plane" }}'
      dockerfile: services/internal/control-plane/Dockerfile
      context: .
    worker:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/worker" }}'
      tagTemplate: '{{ .Env }}-{{ index .Versions "worker" }}'
      dockerfile: services/jobs/worker/Dockerfile
      context: .
    agent-runner:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/agent-runner" }}'
      tagTemplate: '{{ .Env }}-{{ index .Versions "agent-runner" }}'
      dockerfile: services/jobs/agent-runner/Dockerfile
      context: .
    web-console:
      type: '{{ ternary (eq .Env "ai") "build" "skip" }}'
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/web-console" }}'
      tagTemplate: '{{ .Env }}-{{ index .Versions "web-console" }}'
      dockerfile: services/staff/web-console/Dockerfile
      context: services/staff/web-console
  orchestration:
    deployOrder:
      - stateful
      - migrations
      - internal
      - edge
      - frontend
    cleanupPolicy:
      fullEnvIdleTTL: 8h
  infrastructure:
    - name: namespace
      manifests:
        - path: deploy/base/namespace/namespace.yaml.tpl
    - name: repo-cache
      dependsOn:
        - namespace
      manifests:
        - path: deploy/base/codex-k8s/repo-cache-pvc.yaml.tpl
    - name: network-policy-baseline
      dependsOn:
        - namespace
      when: '{{ and (ne .Env "ai") (eq (envOr "CODEXK8S_NETWORK_POLICY_BASELINE" "true") "true") }}'
      manifests:
        - path: deploy/base/network-policies/platform-baseline.yaml.tpl
    - name: postgres
      dependsOn:
        - namespace
      manifests:
        - path: deploy/base/postgres/postgres.yaml.tpl
    - name: registry
      dependsOn:
        - namespace
      when: '{{ ternary (eq .Env "ai") "false" "true" }}'
      manifests:
        - path: deploy/base/registry/registry.yaml.tpl
    - name: cert-manager-clusterissuer
      # Manage ClusterIssuer only when runtime TLS flow explicitly requests it.
      # Otherwise keep existing issuer (if any) untouched to avoid invalid patches.
      when: '{{ and (eq (envOr "CODEXK8S_CERT_ISSUER_ENABLED" "false") "true") (ne (envOr "CODEXK8S_LETSENCRYPT_EMAIL" "") "") (ne (envOr "CODEXK8S_LETSENCRYPT_SERVER" "") "") }}'
      manifests:
        - path: deploy/base/cert-manager/clusterissuer.yaml.tpl
  services:
    - name: codex-k8s-migrate
      use:
        - hot-reload-defaults
      deployGroup: migrations
      dependsOn:
        - postgres
      manifests:
        - path: deploy/base/codex-k8s/migrate-job.yaml.tpl
    - name: codex-k8s-app
      use:
        - hot-reload-defaults
      deployGroup: internal
      dependsOn:
        - postgres
      manifests:
        - path: deploy/base/codex-k8s/app.yaml.tpl
    - name: oauth2-proxy
      use:
        - hot-reload-defaults
      scope: infrastructure-singleton
      deployGroup: edge
      dependsOn:
        - codex-k8s-app
      when: '{{ eq (envOr "CODEXK8S_OAUTH2_PROXY_ENABLED" "true") "true" }}'
      manifests:
        - path: deploy/base/oauth2-proxy/oauth2-proxy.yaml.tpl
    - name: web-console
      use:
        - hot-reload-defaults
      deployGroup: frontend
      dependsOn:
        - codex-k8s-app
      when: '{{ ternary (eq .Env "ai") "true" "false" }}'
      manifests:
        - path: deploy/base/web-console/web-console.yaml.tpl
    - name: registry-gc
      use:
        - hot-reload-defaults
      deployGroup: edge
      dependsOn:
        - registry
        - codex-k8s-app
      when: '{{ ternary (eq .Env "ai") "false" "true" }}'
      manifests:
        - path: deploy/base/registry/registry-gc.yaml.tpl
    - name: ingress
      use:
        - hot-reload-defaults
      deployGroup: edge
      dependsOn:
        - oauth2-proxy
      when: '{{ eq (envOr "CODEXK8S_INGRESS_ENABLED" "true") "true" }}'
      manifests:
        - path: deploy/base/codex-k8s/ingress.yaml.tpl

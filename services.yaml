apiVersion: codex-k8s.dev/v1alpha1
kind: ServiceStack
metadata:
  name: codex-k8s

spec:
  project: codex-k8s
  versions:
    api-gateway: "0.1.0"
    control-plane: "0.1.1"
    worker: "0.1.0"
    agent-runner: "0.1.0"
    web-console: "0.1.0"
    alpine-git: "2.47.2"
    kaniko-executor: "v1.23.2-debug"
    busybox: "1.36"
    pgvector: "pg16"
    oauth2-proxy: "v7.6.0"
    golang-alpine: "1.25.6-alpine"
    golang-bookworm: "1.25.6-bookworm"
    golang-codegen: "1.24-bookworm"
    node-alpine: "22-alpine"
    node-bookworm: "22-bookworm"
    nginx-alpine: "1.27-alpine"

  components:
    - name: hot-reload-defaults
      serviceDefaults:
        # production is prod-like. Hot-reload is only supported in ai slots.
        codeUpdateStrategy: '{{ ternary (eq .Env "ai") "hot-reload" "restart" }}'

  environments:
    dev:
      namespaceTemplate: "{{ .Project }}-dev"
    production:
      namespaceTemplate: "{{ .Project }}-prod"
    ai:
      from: production
      namespaceTemplate: "{{ .Project }}-dev-{{ .Slot }}"
    ai-repair:
      from: production
      namespaceTemplate: "{{ .Project }}-prod"

  webhookRuntime:
    defaultMode: full-env
    triggerModes:
      intake: code-only
      intake_revise: code-only
      vision: code-only
      vision_revise: code-only
      prd: code-only
      prd_revise: code-only
      self_improve: code-only

  images:
    kaniko-clone:
      type: external
      from: 'alpine/git:2.47.2'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/alpine-git:2.47.2'

    kaniko-executor:
      type: external
      from: 'gcr.io/kaniko-project/executor:v1.23.2-debug'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/kaniko-executor:v1.23.2-debug'

    repo-sync:
      type: external
      from: 'alpine/git:2.47.2'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/alpine-git:2.47.2'

    busybox:
      type: external
      from: 'busybox:1.36'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/busybox:1.36'

    postgres:
      type: external
      from: 'pgvector/pgvector:pg16'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/pgvector:pg16'

    oauth2-proxy:
      type: external
      from: 'quay.io/oauth2-proxy/oauth2-proxy:v7.6.0'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/oauth2-proxy:v7.6.0'

    codegen-check:
      type: external
      from: 'golang:1.24-bookworm'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:1.24-bookworm'

    golang-alpine:
      type: external
      from: 'golang:1.25.6-alpine'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:1.25.6-alpine'

    golang-bookworm:
      type: external
      from: 'golang:1.25.6-bookworm'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/golang:1.25.6-bookworm'

    node-alpine:
      type: external
      from: 'node:22-alpine'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/node:22-alpine'

    node-bookworm:
      type: external
      from: 'node:22-bookworm'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/node:22-bookworm'

    nginx-alpine:
      type: external
      from: 'nginx:1.27-alpine'
      local: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/codex-k8s/mirror/nginx:1.27-alpine'

    api-gateway:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/api-gateway" }}'
      tagTemplate: '{{ .Env }}-0.1.0'
      dockerfile: services/external/api-gateway/Dockerfile
      context: .

    control-plane:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/control-plane" }}'
      tagTemplate: '{{ .Env }}-0.1.1'
      dockerfile: services/internal/control-plane/Dockerfile
      context: .

    worker:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/worker" }}'
      tagTemplate: '{{ .Env }}-0.1.0'
      dockerfile: services/jobs/worker/Dockerfile
      context: .

    agent-runner:
      type: build
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/agent-runner" }}'
      tagTemplate: '{{ .Env }}-0.1.0'
      dockerfile: services/jobs/agent-runner/Dockerfile
      context: .

    web-console:
      type: '{{ ternary (eq .Env "ai") "build" "skip" }}'
      repository: '{{ envOr "CODEXK8S_INTERNAL_REGISTRY_HOST" "127.0.0.1:5000" }}/{{ envOr "CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY" "codex-k8s/web-console" }}'
      tagTemplate: '{{ .Env }}-0.1.0'
      dockerfile: services/staff/web-console/Dockerfile
      context: services/staff/web-console

  orchestration:
    deployOrder:
      - stateful
      - migrations
      - internal
      - edge
      - frontend
    cleanupPolicy:
      fullEnvIdleTTL: 8h

  infrastructure:
    - name: namespace
      manifests:
        - path: deploy/base/namespace/namespace.yaml.tpl

    - name: repo-cache
      dependsOn:
        - namespace
      manifests:
        - path: deploy/base/codex-k8s/repo-cache-pvc.yaml.tpl

    - name: network-policy-baseline
      dependsOn:
        - namespace
      when: '{{ and (ne .Env "ai") (eq (envOr "CODEXK8S_NETWORK_POLICY_BASELINE" "true") "true") }}'
      manifests:
        - path: deploy/base/network-policies/platform-baseline.yaml.tpl

    - name: postgres
      dependsOn:
        - namespace
      manifests:
        - path: deploy/base/postgres/postgres.yaml.tpl

    - name: registry
      dependsOn:
        - namespace
      when: '{{ ternary (eq .Env "ai") "false" "true" }}'
      manifests:
        - path: deploy/base/registry/registry.yaml.tpl

    - name: cert-manager-clusterissuer
      # Manage ClusterIssuer only when runtime TLS flow explicitly requests it.
      # Otherwise keep existing issuer (if any) untouched to avoid invalid patches.
      when: '{{ and (eq (envOr "CODEXK8S_CERT_ISSUER_ENABLED" "false") "true") (ne (envOr "CODEXK8S_LETSENCRYPT_EMAIL" "") "") (ne (envOr "CODEXK8S_LETSENCRYPT_SERVER" "") "") }}'
      manifests:
        - path: deploy/base/cert-manager/clusterissuer.yaml.tpl

  services:
    - name: codex-k8s-migrate
      use:
        - hot-reload-defaults
      deployGroup: migrations
      dependsOn:
        - postgres
      manifests:
        - path: deploy/base/codex-k8s/migrate-job.yaml.tpl

    - name: codex-k8s-app
      use:
        - hot-reload-defaults
      deployGroup: internal
      dependsOn:
        - postgres
      manifests:
        - path: deploy/base/codex-k8s/app.yaml.tpl

    - name: oauth2-proxy
      use:
        - hot-reload-defaults
      deployGroup: edge
      dependsOn:
        - codex-k8s-app
      when: '{{ eq (envOr "CODEXK8S_OAUTH2_PROXY_ENABLED" "true") "true" }}'
      manifests:
        - path: deploy/base/oauth2-proxy/oauth2-proxy.yaml.tpl

    - name: web-console
      use:
        - hot-reload-defaults
      deployGroup: frontend
      dependsOn:
        - codex-k8s-app
      when: '{{ ternary (eq .Env "ai") "true" "false" }}'
      manifests:
        - path: deploy/base/web-console/web-console.yaml.tpl

    - name: ingress
      use:
        - hot-reload-defaults
      deployGroup: edge
      dependsOn:
        - oauth2-proxy
      when: '{{ eq (envOr "CODEXK8S_INGRESS_ENABLED" "true") "true" }}'
      manifests:
        - path: deploy/base/codex-k8s/ingress.yaml.tpl

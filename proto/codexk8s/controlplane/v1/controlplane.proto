syntax = "proto3";

package codexk8s.controlplane.v1;

option go_package = "github.com/codex-k8s/codex-k8s/proto/gen/go/codexk8s/controlplane/v1;controlplanev1";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

message Principal {
  string user_id = 1;
  string email = 2;
  string github_login = 3;
  bool is_platform_admin = 4;
  bool is_platform_owner = 5;
}

message IngestGitHubWebhookRequest {
  string correlation_id = 1;
  string event_type = 2;
  string delivery_id = 3;
  google.protobuf.Timestamp received_at = 4;
  bytes payload_json = 5;
}

message IngestGitHubWebhookResponse {
  string correlation_id = 1;
  string run_id = 2;
  string status = 3;
  bool duplicate = 4;
}

message ResolveStaffByEmailRequest {
  string email = 1;
  optional string github_login = 2;
}

message ResolveStaffByEmailResponse {
  Principal principal = 1;
}

message AuthorizeOAuthUserRequest {
  string email = 1;
  int64 github_user_id = 2;
  string github_login = 3;
}

message AuthorizeOAuthUserResponse {
  Principal principal = 1;
}

message Project {
  string id = 1;
  string slug = 2;
  string name = 3;
  string role = 4;
}

message ListProjectsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListProjectsResponse {
  repeated Project items = 1;
}

message UpsertProjectRequest {
  Principal principal = 1;
  string slug = 2;
  string name = 3;
}

message GetProjectRequest {
  Principal principal = 1;
  string project_id = 2;
}

message DeleteProjectRequest {
  Principal principal = 1;
  string project_id = 2;
}

message Run {
  string id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  optional string project_slug = 4;
  optional string project_name = 5;
  string status = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp started_at = 8;
  google.protobuf.Timestamp finished_at = 9;
  optional int32 issue_number = 10;
  optional string issue_url = 11;
  optional int32 pr_number = 12;
  optional string pr_url = 13;
  optional string trigger_kind = 14;
  optional string trigger_label = 15;
  optional string job_name = 16;
  optional string job_namespace = 17;
  optional string namespace = 18;
  bool job_exists = 19;
  bool namespace_exists = 20;
  optional string wait_state = 21;
  optional string wait_reason = 22;
  optional string agent_key = 23;
  google.protobuf.Timestamp wait_since = 24;
  google.protobuf.Timestamp last_heartbeat_at = 25;
}

message ApprovalRequest {
  int64 id = 1;
  string correlation_id = 2;
  optional string run_id = 3;
  optional string project_id = 4;
  optional string project_slug = 5;
  optional string project_name = 6;
  google.protobuf.Int32Value issue_number = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string trigger_label = 9;
  string tool_name = 10;
  string action = 11;
  string approval_mode = 12;
  string requested_by = 13;
  google.protobuf.Timestamp created_at = 14;
}

message ListPendingApprovalsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListPendingApprovalsResponse {
  repeated ApprovalRequest items = 1;
}

message ResolveApprovalDecisionRequest {
  Principal principal = 1;
  int64 approval_request_id = 2;
  string decision = 3;
  optional string reason = 4;
}

message ResolveApprovalDecisionResponse {
  int64 id = 1;
  string correlation_id = 2;
  optional string run_id = 3;
  string tool_name = 4;
  string action = 5;
  string approval_state = 6;
}

message ListRunsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListRunsResponse {
  repeated Run items = 1;
}

message ListRunJobsRequest {
  Principal principal = 1;
  int32 limit = 2;
  optional string trigger_kind = 3;
  optional string status = 4;
  optional string agent_key = 5;
}

message ListRunJobsResponse {
  repeated Run items = 1;
}

message ListRunWaitsRequest {
  Principal principal = 1;
  int32 limit = 2;
  optional string trigger_kind = 3;
  optional string status = 4;
  optional string agent_key = 5;
  optional string wait_state = 6;
}

message ListRunWaitsResponse {
  repeated Run items = 1;
}

message GetRunRequest {
  Principal principal = 1;
  string run_id = 2;
}

message GetRunLogsRequest {
  Principal principal = 1;
  string run_id = 2;
  int32 tail_lines = 3;
}

message RunLogs {
  string run_id = 1;
  string status = 2;
  google.protobuf.Timestamp updated_at = 3;
  string snapshot_json = 4;
  repeated string tail_lines = 5;
}

message FlowEvent {
  string correlation_id = 1;
  string event_type = 2;
  google.protobuf.Timestamp created_at = 3;
  string payload_json = 4;
}

message ListRunEventsRequest {
  Principal principal = 1;
  string run_id = 2;
  int32 limit = 3;
}

message ListRunEventsResponse {
  repeated FlowEvent items = 1;
}

message LearningFeedback {
  int64 id = 1;
  string run_id = 2;
  optional string repository_id = 3;
  optional int32 pr_number = 4;
  optional string file_path = 5;
  optional int32 line = 6;
  string kind = 7;
  string explanation = 8;
  google.protobuf.Timestamp created_at = 9;
}

message ListRunLearningFeedbackRequest {
  Principal principal = 1;
  string run_id = 2;
  int32 limit = 3;
}

message ListRunLearningFeedbackResponse {
  repeated LearningFeedback items = 1;
}

message User {
  string id = 1;
  string email = 2;
  optional int64 github_user_id = 3;
  optional string github_login = 4;
  bool is_platform_admin = 5;
  bool is_platform_owner = 6;
}

message ListUsersRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListUsersResponse {
  repeated User items = 1;
}

message CreateUserRequest {
  Principal principal = 1;
  string email = 2;
  bool is_platform_admin = 3;
}

message DeleteUserRequest {
  Principal principal = 1;
  string user_id = 2;
}

message ProjectMember {
  string project_id = 1;
  string user_id = 2;
  string email = 3;
  string role = 4;
  google.protobuf.BoolValue learning_mode_override = 5;
}

message ListProjectMembersRequest {
  Principal principal = 1;
  string project_id = 2;
  int32 limit = 3;
}

message ListProjectMembersResponse {
  repeated ProjectMember items = 1;
}

message UpsertProjectMemberRequest {
  Principal principal = 1;
  string project_id = 2;
  optional string user_id = 3;
  optional string email = 4;
  string role = 5;
}

message DeleteProjectMemberRequest {
  Principal principal = 1;
  string project_id = 2;
  string user_id = 3;
}

message SetProjectMemberLearningModeOverrideRequest {
  Principal principal = 1;
  string project_id = 2;
  string user_id = 3;
  google.protobuf.BoolValue enabled = 4;
}

message RepositoryBinding {
  string id = 1;
  string project_id = 2;
  string provider = 3;
  int64 external_id = 4;
  string owner = 5;
  string name = 6;
  string services_yaml_path = 7;
  optional string bot_username = 8;
  optional string bot_email = 9;
  optional string preflight_updated_at = 10;
}

message ListProjectRepositoriesRequest {
  Principal principal = 1;
  string project_id = 2;
  int32 limit = 3;
}

message ListProjectRepositoriesResponse {
  repeated RepositoryBinding items = 1;
}

message UpsertProjectRepositoryRequest {
  Principal principal = 1;
  string project_id = 2;
  string provider = 3;
  string owner = 4;
  string name = 5;
  string token = 6;
  string services_yaml_path = 7;
}

message DeleteProjectRepositoryRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
}

message UpsertRepositoryBotParamsRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
  optional string bot_token = 4;
  optional string bot_username = 5;
  optional string bot_email = 6;
}

message RunRepositoryPreflightRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
}

message PreflightCheckResult {
  string name = 1;
  string status = 2;
  optional string details = 3;
}

message RunRepositoryPreflightResponse {
  string repository_id = 1;
  string status = 2;
  repeated PreflightCheckResult checks = 3;
  string report_json = 4;
  google.protobuf.Timestamp finished_at = 5;
}

message ProjectGitHubTokens {
  string project_id = 1;
  bool has_platform_token = 2;
  bool has_bot_token = 3;
  optional string bot_username = 4;
  optional string bot_email = 5;
}

message GetProjectGitHubTokensRequest {
  Principal principal = 1;
  string project_id = 2;
}

message UpsertProjectGitHubTokensRequest {
  Principal principal = 1;
  string project_id = 2;
  optional string platform_token = 3;
  optional string bot_token = 4;
  optional string bot_username = 5;
  optional string bot_email = 6;
}

message ConfigEntry {
  string id = 1;
  string scope = 2;
  string kind = 3;
  optional string project_id = 4;
  optional string repository_id = 5;
  string key = 6;
  optional string value = 7;
  repeated string sync_targets = 8;
  string mutability = 9;
  bool is_dangerous = 10;
  optional string updated_at = 11;
}

message ListConfigEntriesRequest {
  Principal principal = 1;
  string scope = 2;
  optional string project_id = 3;
  optional string repository_id = 4;
  int32 limit = 5;
}

message ListConfigEntriesResponse {
  repeated ConfigEntry items = 1;
}

message UpsertConfigEntryRequest {
  Principal principal = 1;
  string scope = 2;
  string kind = 3;
  optional string project_id = 4;
  optional string repository_id = 5;
  string key = 6;
  optional string value_plain = 7;
  optional string value_secret = 8;
  repeated string sync_targets = 9;
  string mutability = 10;
  bool is_dangerous = 11;
  bool dangerous_confirmed = 12;
}

message DeleteConfigEntryRequest {
  Principal principal = 1;
  string config_entry_id = 2;
}

message DocsetGroup {
  string id = 1;
  string title = 2;
  string description = 3;
  bool default_selected = 4;
}

message ListDocsetGroupsRequest {
  Principal principal = 1;
  string docset_ref = 2;
  string locale = 3;
}

message ListDocsetGroupsResponse {
  repeated DocsetGroup groups = 1;
}

message ImportDocsetRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
  string docset_ref = 4;
  string locale = 5;
  repeated string group_ids = 6;
}

message ImportDocsetResponse {
  string repository_full_name = 1;
  int32 pr_number = 2;
  string pr_url = 3;
  string branch = 4;
  int32 files_total = 5;
}

message SyncDocsetRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
  string docset_ref = 4;
}

message SyncDocsetResponse {
  string repository_full_name = 1;
  int32 pr_number = 2;
  string pr_url = 3;
  string branch = 4;
  int32 files_updated = 5;
  int32 files_drift = 6;
}

message IssueRunMCPTokenRequest {
  string run_id = 1;
  string namespace = 2;
  string runtime_mode = 3;
  int32 ttl_seconds = 4;
}

message IssueRunMCPTokenResponse {
  string token = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message PrepareRunEnvironmentRequest {
  string run_id = 1;
  string runtime_mode = 2;
  string namespace = 3;
  string target_env = 4;
  int32 slot_no = 5;
  string repository_full_name = 6;
  string services_yaml_path = 7;
  string build_ref = 8;
  bool deploy_only = 9;
}

message PrepareRunEnvironmentResponse {
  bool ok = 1;
  string run_id = 2;
  string namespace = 3;
  string target_env = 4;
}

message RuntimeDeployTaskLog {
  string stage = 1;
  string level = 2;
  string message = 3;
  google.protobuf.Timestamp created_at = 4;
}

message RuntimeDeployTask {
  string run_id = 1;
  string runtime_mode = 2;
  string namespace = 3;
  string target_env = 4;
  int32 slot_no = 5;
  string repository_full_name = 6;
  string services_yaml_path = 7;
  string build_ref = 8;
  bool deploy_only = 9;
  string status = 10;
  optional string lease_owner = 11;
  google.protobuf.Timestamp lease_until = 12;
  int32 attempts = 13;
  optional string last_error = 14;
  optional string result_namespace = 15;
  optional string result_target_env = 16;
  google.protobuf.Timestamp created_at = 17;
  google.protobuf.Timestamp updated_at = 18;
  google.protobuf.Timestamp started_at = 19;
  google.protobuf.Timestamp finished_at = 20;
  repeated RuntimeDeployTaskLog logs = 21;
}

message ListRuntimeDeployTasksRequest {
  Principal principal = 1;
  int32 limit = 2;
  optional string status = 3;
  optional string target_env = 4;
}

message ListRuntimeDeployTasksResponse {
  repeated RuntimeDeployTask items = 1;
}

message GetRuntimeDeployTaskRequest {
  Principal principal = 1;
  string run_id = 2;
}

message RegistryImageTag {
  string tag = 1;
  string digest = 2;
  google.protobuf.Timestamp created_at = 3;
  int64 config_size_bytes = 4;
}

message RegistryImageRepository {
  string repository = 1;
  int32 tag_count = 2;
  repeated RegistryImageTag tags = 3;
}

message ListRegistryImagesRequest {
  Principal principal = 1;
  int32 limit_repositories = 2;
  int32 limit_tags = 3;
  optional string repository = 4;
}

message ListRegistryImagesResponse {
  repeated RegistryImageRepository items = 1;
}

message DeleteRegistryImageTagRequest {
  Principal principal = 1;
  string repository = 2;
  string tag = 3;
}

message RegistryImageDeleteResult {
  string repository = 1;
  string tag = 2;
  string digest = 3;
  bool deleted = 4;
}

message CleanupRegistryImagesRequest {
  Principal principal = 1;
  optional string repository_prefix = 2;
  int32 limit_repositories = 3;
  int32 keep_tags = 4;
  bool dry_run = 5;
}

message CleanupRegistryImagesResponse {
  int32 repositories_scanned = 1;
  int32 tags_deleted = 2;
  int32 tags_skipped = 3;
  repeated RegistryImageDeleteResult deleted = 4;
  repeated RegistryImageDeleteResult skipped = 5;
}

message UpsertAgentSessionRequest {
  string run_id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  string repository_full_name = 4;
  string agent_key = 5;
  google.protobuf.Int32Value issue_number = 6;
  string branch_name = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string pr_url = 9;
  optional string trigger_kind = 10;
  optional string template_kind = 11;
  optional string template_source = 12;
  optional string template_locale = 13;
  optional string model = 14;
  optional string reasoning_effort = 15;
  optional string status = 16;
  optional string session_id = 17;
  optional bytes session_json = 18;
  optional string codex_cli_session_path = 19;
  optional bytes codex_cli_session_json = 20;
  google.protobuf.Timestamp started_at = 21;
  google.protobuf.Timestamp finished_at = 22;
}

message UpsertAgentSessionResponse {
  bool ok = 1;
  string run_id = 2;
}

message AgentSessionSnapshot {
  string run_id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  string repository_full_name = 4;
  string agent_key = 5;
  google.protobuf.Int32Value issue_number = 6;
  string branch_name = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string pr_url = 9;
  optional string trigger_kind = 10;
  optional string template_kind = 11;
  optional string template_source = 12;
  optional string template_locale = 13;
  optional string model = 14;
  optional string reasoning_effort = 15;
  optional string status = 16;
  optional string session_id = 17;
  optional bytes session_json = 18;
  optional string codex_cli_session_path = 19;
  optional bytes codex_cli_session_json = 20;
  google.protobuf.Timestamp started_at = 21;
  google.protobuf.Timestamp finished_at = 22;
  google.protobuf.Timestamp created_at = 23;
  google.protobuf.Timestamp updated_at = 24;
}

message GetLatestAgentSessionRequest {
  string repository_full_name = 1;
  string branch_name = 2;
  string agent_key = 3;
}

message GetLatestAgentSessionResponse {
  bool found = 1;
  AgentSessionSnapshot session = 2;
}

message InsertRunFlowEventRequest {
  string run_id = 1;
  string event_type = 2;
  bytes payload_json = 3;
}

message InsertRunFlowEventResponse {
  bool ok = 1;
  string event_type = 2;
}

message UpsertRunStatusCommentRequest {
  string run_id = 1;
  string phase = 2;
  optional string job_name = 3;
  optional string job_namespace = 4;
  optional string runtime_mode = 5;
  optional string namespace = 6;
  optional string trigger_kind = 7;
  optional string prompt_locale = 8;
  optional string run_status = 9;
  bool deleted = 10;
  bool already_deleted = 11;
  optional string model = 12;
  optional string reasoning_effort = 13;
}

message UpsertRunStatusCommentResponse {
  bool ok = 1;
  string run_id = 2;
  int64 comment_id = 3;
  optional string comment_url = 4;
}

message DeleteRunNamespaceRequest {
  Principal principal = 1;
  string run_id = 2;
}

message DeleteRunNamespaceResponse {
  bool ok = 1;
  string run_id = 2;
  string namespace = 3;
  bool deleted = 4;
  bool already_deleted = 5;
  optional string comment_url = 6;
}

service ControlPlaneService {
  rpc IngestGitHubWebhook(IngestGitHubWebhookRequest) returns (IngestGitHubWebhookResponse);

  // Used by api-gateway staff auth when oauth2-proxy injects identity headers.
  rpc ResolveStaffByEmail(ResolveStaffByEmailRequest) returns (ResolveStaffByEmailResponse);

  // Used by api-gateway OAuth callback to enforce allowlist and persist GitHub identity.
  rpc AuthorizeOAuthUser(AuthorizeOAuthUserRequest) returns (AuthorizeOAuthUserResponse);

  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse);
  rpc UpsertProject(UpsertProjectRequest) returns (Project);
  rpc GetProject(GetProjectRequest) returns (Project);
  rpc DeleteProject(DeleteProjectRequest) returns (google.protobuf.Empty);

  rpc ListRuns(ListRunsRequest) returns (ListRunsResponse);
  rpc ListRunJobs(ListRunJobsRequest) returns (ListRunJobsResponse);
  rpc ListRunWaits(ListRunWaitsRequest) returns (ListRunWaitsResponse);
  rpc GetRun(GetRunRequest) returns (Run);
  rpc GetRunLogs(GetRunLogsRequest) returns (RunLogs);
  rpc ListPendingApprovals(ListPendingApprovalsRequest) returns (ListPendingApprovalsResponse);
  rpc ResolveApprovalDecision(ResolveApprovalDecisionRequest) returns (ResolveApprovalDecisionResponse);
  rpc ListRunEvents(ListRunEventsRequest) returns (ListRunEventsResponse);
  rpc ListRunLearningFeedback(ListRunLearningFeedbackRequest) returns (ListRunLearningFeedbackResponse);

  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc CreateUser(CreateUserRequest) returns (User);
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty);

  rpc ListProjectMembers(ListProjectMembersRequest) returns (ListProjectMembersResponse);
  rpc UpsertProjectMember(UpsertProjectMemberRequest) returns (google.protobuf.Empty);
  rpc DeleteProjectMember(DeleteProjectMemberRequest) returns (google.protobuf.Empty);
  rpc SetProjectMemberLearningModeOverride(SetProjectMemberLearningModeOverrideRequest) returns (google.protobuf.Empty);

  rpc ListProjectRepositories(ListProjectRepositoriesRequest) returns (ListProjectRepositoriesResponse);
  rpc UpsertProjectRepository(UpsertProjectRepositoryRequest) returns (RepositoryBinding);
  rpc DeleteProjectRepository(DeleteProjectRepositoryRequest) returns (google.protobuf.Empty);
  rpc UpsertRepositoryBotParams(UpsertRepositoryBotParamsRequest) returns (google.protobuf.Empty);
  rpc RunRepositoryPreflight(RunRepositoryPreflightRequest) returns (RunRepositoryPreflightResponse);

  rpc GetProjectGitHubTokens(GetProjectGitHubTokensRequest) returns (ProjectGitHubTokens);
  rpc UpsertProjectGitHubTokens(UpsertProjectGitHubTokensRequest) returns (google.protobuf.Empty);

  rpc ListConfigEntries(ListConfigEntriesRequest) returns (ListConfigEntriesResponse);
  rpc UpsertConfigEntry(UpsertConfigEntryRequest) returns (ConfigEntry);
  rpc DeleteConfigEntry(DeleteConfigEntryRequest) returns (google.protobuf.Empty);

  rpc ListDocsetGroups(ListDocsetGroupsRequest) returns (ListDocsetGroupsResponse);
  rpc ImportDocset(ImportDocsetRequest) returns (ImportDocsetResponse);
  rpc SyncDocset(SyncDocsetRequest) returns (SyncDocsetResponse);
  rpc IssueRunMCPToken(IssueRunMCPTokenRequest) returns (IssueRunMCPTokenResponse);
  rpc PrepareRunEnvironment(PrepareRunEnvironmentRequest) returns (PrepareRunEnvironmentResponse);
  rpc ListRuntimeDeployTasks(ListRuntimeDeployTasksRequest) returns (ListRuntimeDeployTasksResponse);
  rpc GetRuntimeDeployTask(GetRuntimeDeployTaskRequest) returns (RuntimeDeployTask);
  rpc ListRegistryImages(ListRegistryImagesRequest) returns (ListRegistryImagesResponse);
  rpc DeleteRegistryImageTag(DeleteRegistryImageTagRequest) returns (RegistryImageDeleteResult);
  rpc CleanupRegistryImages(CleanupRegistryImagesRequest) returns (CleanupRegistryImagesResponse);

  // Used by agent-runner for run-bound session persistence and event callbacks.
  rpc UpsertAgentSession(UpsertAgentSessionRequest) returns (UpsertAgentSessionResponse);
  rpc GetLatestAgentSession(GetLatestAgentSessionRequest) returns (GetLatestAgentSessionResponse);
  rpc InsertRunFlowEvent(InsertRunFlowEventRequest) returns (InsertRunFlowEventResponse);
  rpc UpsertRunStatusComment(UpsertRunStatusCommentRequest) returns (UpsertRunStatusCommentResponse);
  rpc DeleteRunNamespace(DeleteRunNamespaceRequest) returns (DeleteRunNamespaceResponse);
}

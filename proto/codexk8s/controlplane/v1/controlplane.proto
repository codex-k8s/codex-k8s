syntax = "proto3";

package codexk8s.controlplane.v1;

option go_package = "github.com/codex-k8s/codex-k8s/proto/gen/go/codexk8s/controlplane/v1;controlplanev1";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/wrappers.proto";

message Principal {
  string user_id = 1;
  string email = 2;
  string github_login = 3;
  bool is_platform_admin = 4;
  bool is_platform_owner = 5;
}

message IngestGitHubWebhookRequest {
  string correlation_id = 1;
  string event_type = 2;
  string delivery_id = 3;
  google.protobuf.Timestamp received_at = 4;
  bytes payload_json = 5;
}

message IngestGitHubWebhookResponse {
  string correlation_id = 1;
  string run_id = 2;
  string status = 3;
  bool duplicate = 4;
}

message ResolveStaffByEmailRequest {
  string email = 1;
  optional string github_login = 2;
}

message ResolveStaffByEmailResponse {
  Principal principal = 1;
}

message AuthorizeOAuthUserRequest {
  string email = 1;
  int64 github_user_id = 2;
  string github_login = 3;
}

message AuthorizeOAuthUserResponse {
  Principal principal = 1;
}

message Project {
  string id = 1;
  string slug = 2;
  string name = 3;
  string role = 4;
}

message ListProjectsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListProjectsResponse {
  repeated Project items = 1;
}

message UpsertProjectRequest {
  Principal principal = 1;
  string slug = 2;
  string name = 3;
}

message GetProjectRequest {
  Principal principal = 1;
  string project_id = 2;
}

message DeleteProjectRequest {
  Principal principal = 1;
  string project_id = 2;
}

message Run {
  string id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  optional string project_slug = 4;
  optional string project_name = 5;
  string status = 6;
  google.protobuf.Timestamp created_at = 7;
  google.protobuf.Timestamp started_at = 8;
  google.protobuf.Timestamp finished_at = 9;
  optional int32 issue_number = 10;
  optional string issue_url = 11;
  optional int32 pr_number = 12;
  optional string pr_url = 13;
  optional string trigger_kind = 14;
  optional string trigger_label = 15;
  optional string job_name = 16;
  optional string job_namespace = 17;
  optional string namespace = 18;
  bool job_exists = 19;
  bool namespace_exists = 20;
  optional string wait_state = 21;
  optional string wait_reason = 22;
}

message ApprovalRequest {
  int64 id = 1;
  string correlation_id = 2;
  optional string run_id = 3;
  optional string project_id = 4;
  optional string project_slug = 5;
  optional string project_name = 6;
  google.protobuf.Int32Value issue_number = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string trigger_label = 9;
  string tool_name = 10;
  string action = 11;
  string approval_mode = 12;
  string requested_by = 13;
  google.protobuf.Timestamp created_at = 14;
}

message ListPendingApprovalsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListPendingApprovalsResponse {
  repeated ApprovalRequest items = 1;
}

message ResolveApprovalDecisionRequest {
  Principal principal = 1;
  int64 approval_request_id = 2;
  string decision = 3;
  optional string reason = 4;
}

message ResolveApprovalDecisionResponse {
  int64 id = 1;
  string correlation_id = 2;
  optional string run_id = 3;
  string tool_name = 4;
  string action = 5;
  string approval_state = 6;
}

message ListRunsRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListRunsResponse {
  repeated Run items = 1;
}

message GetRunRequest {
  Principal principal = 1;
  string run_id = 2;
}

message FlowEvent {
  string correlation_id = 1;
  string event_type = 2;
  google.protobuf.Timestamp created_at = 3;
  string payload_json = 4;
}

message ListRunEventsRequest {
  Principal principal = 1;
  string run_id = 2;
  int32 limit = 3;
}

message ListRunEventsResponse {
  repeated FlowEvent items = 1;
}

message LearningFeedback {
  int64 id = 1;
  string run_id = 2;
  optional string repository_id = 3;
  optional int32 pr_number = 4;
  optional string file_path = 5;
  optional int32 line = 6;
  string kind = 7;
  string explanation = 8;
  google.protobuf.Timestamp created_at = 9;
}

message ListRunLearningFeedbackRequest {
  Principal principal = 1;
  string run_id = 2;
  int32 limit = 3;
}

message ListRunLearningFeedbackResponse {
  repeated LearningFeedback items = 1;
}

message User {
  string id = 1;
  string email = 2;
  optional int64 github_user_id = 3;
  optional string github_login = 4;
  bool is_platform_admin = 5;
  bool is_platform_owner = 6;
}

message ListUsersRequest {
  Principal principal = 1;
  int32 limit = 2;
}

message ListUsersResponse {
  repeated User items = 1;
}

message CreateUserRequest {
  Principal principal = 1;
  string email = 2;
  bool is_platform_admin = 3;
}

message DeleteUserRequest {
  Principal principal = 1;
  string user_id = 2;
}

message ProjectMember {
  string project_id = 1;
  string user_id = 2;
  string email = 3;
  string role = 4;
  google.protobuf.BoolValue learning_mode_override = 5;
}

message ListProjectMembersRequest {
  Principal principal = 1;
  string project_id = 2;
  int32 limit = 3;
}

message ListProjectMembersResponse {
  repeated ProjectMember items = 1;
}

message UpsertProjectMemberRequest {
  Principal principal = 1;
  string project_id = 2;
  optional string user_id = 3;
  optional string email = 4;
  string role = 5;
}

message DeleteProjectMemberRequest {
  Principal principal = 1;
  string project_id = 2;
  string user_id = 3;
}

message SetProjectMemberLearningModeOverrideRequest {
  Principal principal = 1;
  string project_id = 2;
  string user_id = 3;
  google.protobuf.BoolValue enabled = 4;
}

message RepositoryBinding {
  string id = 1;
  string project_id = 2;
  string provider = 3;
  int64 external_id = 4;
  string owner = 5;
  string name = 6;
  string services_yaml_path = 7;
}

message ListProjectRepositoriesRequest {
  Principal principal = 1;
  string project_id = 2;
  int32 limit = 3;
}

message ListProjectRepositoriesResponse {
  repeated RepositoryBinding items = 1;
}

message UpsertProjectRepositoryRequest {
  Principal principal = 1;
  string project_id = 2;
  string provider = 3;
  string owner = 4;
  string name = 5;
  string token = 6;
  string services_yaml_path = 7;
}

message DeleteProjectRepositoryRequest {
  Principal principal = 1;
  string project_id = 2;
  string repository_id = 3;
}

message IssueRunMCPTokenRequest {
  string run_id = 1;
  string namespace = 2;
  string runtime_mode = 3;
  int32 ttl_seconds = 4;
}

message IssueRunMCPTokenResponse {
  string token = 1;
  google.protobuf.Timestamp expires_at = 2;
}

message UpsertAgentSessionRequest {
  string run_id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  string repository_full_name = 4;
  string agent_key = 5;
  google.protobuf.Int32Value issue_number = 6;
  string branch_name = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string pr_url = 9;
  optional string trigger_kind = 10;
  optional string template_kind = 11;
  optional string template_source = 12;
  optional string template_locale = 13;
  optional string model = 14;
  optional string reasoning_effort = 15;
  optional string status = 16;
  optional string session_id = 17;
  optional bytes session_json = 18;
  optional string codex_cli_session_path = 19;
  optional bytes codex_cli_session_json = 20;
  google.protobuf.Timestamp started_at = 21;
  google.protobuf.Timestamp finished_at = 22;
}

message UpsertAgentSessionResponse {
  bool ok = 1;
  string run_id = 2;
}

message AgentSessionSnapshot {
  string run_id = 1;
  string correlation_id = 2;
  optional string project_id = 3;
  string repository_full_name = 4;
  string agent_key = 5;
  google.protobuf.Int32Value issue_number = 6;
  string branch_name = 7;
  google.protobuf.Int32Value pr_number = 8;
  optional string pr_url = 9;
  optional string trigger_kind = 10;
  optional string template_kind = 11;
  optional string template_source = 12;
  optional string template_locale = 13;
  optional string model = 14;
  optional string reasoning_effort = 15;
  optional string status = 16;
  optional string session_id = 17;
  optional bytes session_json = 18;
  optional string codex_cli_session_path = 19;
  optional bytes codex_cli_session_json = 20;
  google.protobuf.Timestamp started_at = 21;
  google.protobuf.Timestamp finished_at = 22;
  google.protobuf.Timestamp created_at = 23;
  google.protobuf.Timestamp updated_at = 24;
}

message GetLatestAgentSessionRequest {
  string repository_full_name = 1;
  string branch_name = 2;
  string agent_key = 3;
}

message GetLatestAgentSessionResponse {
  bool found = 1;
  AgentSessionSnapshot session = 2;
}

message InsertRunFlowEventRequest {
  string run_id = 1;
  string event_type = 2;
  bytes payload_json = 3;
}

message InsertRunFlowEventResponse {
  bool ok = 1;
  string event_type = 2;
}

message UpsertRunStatusCommentRequest {
  string run_id = 1;
  string phase = 2;
  optional string job_name = 3;
  optional string job_namespace = 4;
  optional string runtime_mode = 5;
  optional string namespace = 6;
  optional string trigger_kind = 7;
  optional string prompt_locale = 8;
  optional string run_status = 9;
  bool deleted = 10;
  bool already_deleted = 11;
  optional string model = 12;
  optional string reasoning_effort = 13;
}

message UpsertRunStatusCommentResponse {
  bool ok = 1;
  string run_id = 2;
  int64 comment_id = 3;
  optional string comment_url = 4;
}

message DeleteRunNamespaceRequest {
  Principal principal = 1;
  string run_id = 2;
}

message DeleteRunNamespaceResponse {
  bool ok = 1;
  string run_id = 2;
  string namespace = 3;
  bool deleted = 4;
  bool already_deleted = 5;
  optional string comment_url = 6;
}

service ControlPlaneService {
  rpc IngestGitHubWebhook(IngestGitHubWebhookRequest) returns (IngestGitHubWebhookResponse);

  // Used by api-gateway staff auth when oauth2-proxy injects identity headers.
  rpc ResolveStaffByEmail(ResolveStaffByEmailRequest) returns (ResolveStaffByEmailResponse);

  // Used by api-gateway OAuth callback to enforce allowlist and persist GitHub identity.
  rpc AuthorizeOAuthUser(AuthorizeOAuthUserRequest) returns (AuthorizeOAuthUserResponse);

  rpc ListProjects(ListProjectsRequest) returns (ListProjectsResponse);
  rpc UpsertProject(UpsertProjectRequest) returns (Project);
  rpc GetProject(GetProjectRequest) returns (Project);
  rpc DeleteProject(DeleteProjectRequest) returns (google.protobuf.Empty);

  rpc ListRuns(ListRunsRequest) returns (ListRunsResponse);
  rpc GetRun(GetRunRequest) returns (Run);
  rpc ListPendingApprovals(ListPendingApprovalsRequest) returns (ListPendingApprovalsResponse);
  rpc ResolveApprovalDecision(ResolveApprovalDecisionRequest) returns (ResolveApprovalDecisionResponse);
  rpc ListRunEvents(ListRunEventsRequest) returns (ListRunEventsResponse);
  rpc ListRunLearningFeedback(ListRunLearningFeedbackRequest) returns (ListRunLearningFeedbackResponse);

  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc CreateUser(CreateUserRequest) returns (User);
  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty);

  rpc ListProjectMembers(ListProjectMembersRequest) returns (ListProjectMembersResponse);
  rpc UpsertProjectMember(UpsertProjectMemberRequest) returns (google.protobuf.Empty);
  rpc DeleteProjectMember(DeleteProjectMemberRequest) returns (google.protobuf.Empty);
  rpc SetProjectMemberLearningModeOverride(SetProjectMemberLearningModeOverrideRequest) returns (google.protobuf.Empty);

  rpc ListProjectRepositories(ListProjectRepositoriesRequest) returns (ListProjectRepositoriesResponse);
  rpc UpsertProjectRepository(UpsertProjectRepositoryRequest) returns (RepositoryBinding);
  rpc DeleteProjectRepository(DeleteProjectRepositoryRequest) returns (google.protobuf.Empty);
  rpc IssueRunMCPToken(IssueRunMCPTokenRequest) returns (IssueRunMCPTokenResponse);

  // Used by agent-runner for run-bound session persistence and event callbacks.
  rpc UpsertAgentSession(UpsertAgentSessionRequest) returns (UpsertAgentSessionResponse);
  rpc GetLatestAgentSession(GetLatestAgentSessionRequest) returns (GetLatestAgentSessionResponse);
  rpc InsertRunFlowEvent(InsertRunFlowEventRequest) returns (InsertRunFlowEventResponse);
  rpc UpsertRunStatusComment(UpsertRunStatusCommentRequest) returns (UpsertRunStatusCommentResponse);
  rpc DeleteRunNamespace(DeleteRunNamespaceRequest) returns (DeleteRunNamespaceResponse);
}

# Инфраструктура: требования к интеграции

Правила работы с PostgreSQL/Redis/Kubernetes/repository providers/секретами/внешними API.
Инфраструктура — деталь и должна быть инкапсулирована (domain/service слои не знают про конкретные SDK).

## PostgreSQL: обязательная модель хранения

- PostgreSQL — единый backend состояния платформы.
- Используем:
  - реляционные таблицы для сущностей и связей;
  - `JSONB` для сессионных/событийных payload;
  - `pgvector` для векторного индекса документов/чанков.
- Схема меняется только миграциями: `cmd/cli/migrations/*.sql` (`goose`, `-- +goose Up/Down`).
- SQL только в `internal/repository/postgres/<model>/sql/*.sql` + `//go:embed`.
- Каждый SQL-запрос в repo слое должен иметь имя-комментарий
  `-- name: <model>__<operation> :one|:many|:exec`.
- Repo слой возвращает доменно-осмысленные ошибки; домен не знает про SQL/pgx.

## Redis (опционально)

- Только для кэша/эфемерных данных/локов.
- Redis не source of truth.
- TTL обязателен по умолчанию.

## Kubernetes интеграция

- Только Kubernetes как оркестратор.
- Все операции выполняются через Go SDK (`client-go`) и адаптеры.
- Shell-вызовы `kubectl` допустимы только как аварийный fallback и не должны быть основной реализацией.
- Действия, меняющие состояние (pods/deployments/namespaces/secrets), логируются в аудит.
- Для multi-pod корректности используется блокировка/синхронизация через БД.

## Webhook/event processing

- Вход в систему — webhook события от repository providers.
- Каждое событие получает correlation id, сохраняется в БД и обрабатывается идемпотентно.
- Повторная доставка webhook не должна приводить к дублированию действий.
- Долгие операции выполняются через job worker с retry/backoff и фиксированием статуса.

## Repository providers (GitHub/GitLab)

- Интеграция только через provider-интерфейсы.
- GitHub — первая реализация; GitLab добавляется без изменения доменного слоя.
- Token lifecycle (создание/ротация/ревокация) реализуется в сервисе.
- Токены в БД храним в зашифрованном виде.

## Секреты и конфигурация

- Секреты платформы и конфиг деплоя `codex-k8s` читаются из env.
- Пользовательские настройки продукта хранятся в БД и управляются через UI.
- Секреты не коммитим, не логируем и не возвращаем в API-ответах.
- В логах и audit payload запрещены ключи и токены в открытом виде.

## CI/CD, образы и окружения

- Каждый Go сервис имеет Dockerfile и воспроизводимую сборку.
- `services.yaml` — единый инвентарь deploy-конфигурации в рамках репозитория.
- Платформа должна уметь развернуться в готовый кластер или установить `k3s` через `bootstrap`.

openapi: 3.0.3
info:
  title: codex-k8s api-gateway
  version: 0.2.0
  description: |
    External webhook + staff API contract for codex-k8s.
servers:
  - url: https://staging.codex-k8s.dev
paths:
  /api/v1/webhooks/github:
    post:
      summary: Ingest GitHub webhook delivery
      operationId: ingestGithubWebhook
      tags: [webhooks]
      parameters:
        - in: header
          name: X-GitHub-Event
          required: true
          schema:
            type: string
        - in: header
          name: X-GitHub-Delivery
          required: true
          schema:
            type: string
        - in: header
          name: X-Hub-Signature-256
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        "202":
          description: Accepted and enqueued for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestGitHubWebhookResponse"
        "200":
          description: Duplicate delivery already ingested
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestGitHubWebhookResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/Internal"

  /api/v1/auth/github/login:
    get:
      summary: Start GitHub OAuth login
      operationId: loginGithub
      tags: [auth]
      responses:
        "302":
          description: Redirect to GitHub OAuth authorize URL
        "500":
          $ref: "#/components/responses/Internal"

  /api/v1/auth/github/callback:
    get:
      summary: Complete GitHub OAuth callback and set auth cookie
      operationId: callbackGithub
      tags: [auth]
      parameters:
        - in: query
          name: state
          required: true
          schema:
            type: string
        - in: query
          name: code
          required: true
          schema:
            type: string
      responses:
        "302":
          description: Redirect to staff UI after successful login
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/Internal"

  /api/v1/auth/logout:
    post:
      summary: Logout current staff user
      operationId: logout
      tags: [auth]
      responses:
        "204":
          description: Logged out
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/auth/me:
    get:
      summary: Get current authenticated staff principal
      operationId: getMe
      tags: [auth]
      responses:
        "200":
          description: Authenticated principal
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/staff/projects:
    get:
      summary: List projects
      operationId: listProjects
      tags: [staff-projects]
      parameters:
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Project list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Create or update a project by slug
      operationId: upsertProject
      tags: [staff-projects]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpsertProjectRequest"
      responses:
        "201":
          description: Project created or updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/Internal"

  /api/v1/staff/projects/{project_id}:
    get:
      summary: Get project by id
      operationId: getProject
      tags: [staff-projects]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
      responses:
        "200":
          description: Project
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Project"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      summary: Delete project by id
      operationId: deleteProject
      tags: [staff-projects]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
      responses:
        "204":
          description: Project deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/runs:
    get:
      summary: List runs
      operationId: listRuns
      tags: [staff-runs]
      parameters:
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Runs list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/staff/runs/{run_id}:
    get:
      summary: Get run by id
      operationId: getRun
      tags: [staff-runs]
      parameters:
        - $ref: "#/components/parameters/RunID"
      responses:
        "200":
          description: Run details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Run"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  /api/v1/staff/runs/{run_id}/namespace:
    delete:
      summary: Force delete run namespace
      operationId: deleteRunNamespace
      tags: [staff-runs]
      parameters:
        - $ref: "#/components/parameters/RunID"
      responses:
        "200":
          description: Namespace cleanup result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RunNamespaceCleanupResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/runs/{run_id}/events:
    get:
      summary: List run flow events
      operationId: listRunEvents
      tags: [staff-runs]
      parameters:
        - $ref: "#/components/parameters/RunID"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Flow events list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FlowEventItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/staff/runs/{run_id}/learning-feedback:
    get:
      summary: List run learning feedback
      operationId: listRunLearningFeedback
      tags: [staff-runs]
      parameters:
        - $ref: "#/components/parameters/RunID"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Learning feedback list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LearningFeedbackItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /api/v1/staff/users:
    get:
      summary: List users
      operationId: listUsers
      tags: [staff-users]
      parameters:
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Users list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Create allowed user
      operationId: createUser
      tags: [staff-users]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateUserRequest"
      responses:
        "201":
          description: User created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/users/{user_id}:
    delete:
      summary: Delete user
      operationId: deleteUser
      tags: [staff-users]
      parameters:
        - $ref: "#/components/parameters/UserID"
      responses:
        "204":
          description: User deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/projects/{project_id}/members:
    get:
      summary: List project members
      operationId: listProjectMembers
      tags: [staff-project-members]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Project members list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProjectMemberItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Add or update project member
      operationId: upsertProjectMember
      tags: [staff-project-members]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpsertProjectMemberRequest"
      responses:
        "204":
          description: Member upserted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/projects/{project_id}/members/{user_id}:
    delete:
      summary: Delete project member
      operationId: deleteProjectMember
      tags: [staff-project-members]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
        - $ref: "#/components/parameters/UserID"
      responses:
        "204":
          description: Member deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/projects/{project_id}/members/{user_id}/learning-mode:
    put:
      summary: Set project member learning mode override
      operationId: setProjectMemberLearningModeOverride
      tags: [staff-project-members]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
        - $ref: "#/components/parameters/UserID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SetProjectMemberLearningModeRequest"
      responses:
        "204":
          description: Learning mode override updated
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/projects/{project_id}/repositories:
    get:
      summary: List project repositories
      operationId: listProjectRepositories
      tags: [staff-project-repositories]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
        - $ref: "#/components/parameters/Limit"
      responses:
        "200":
          description: Project repositories list
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RepositoryBindingItemsResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      summary: Add or update project repository binding
      operationId: upsertProjectRepository
      tags: [staff-project-repositories]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpsertProjectRepositoryRequest"
      responses:
        "201":
          description: Repository binding created or updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RepositoryBinding"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /api/v1/staff/projects/{project_id}/repositories/{repository_id}:
    delete:
      summary: Delete project repository binding
      operationId: deleteProjectRepository
      tags: [staff-project-repositories]
      parameters:
        - $ref: "#/components/parameters/ProjectID"
        - in: path
          name: repository_id
          required: true
          schema:
            type: string
      responses:
        "204":
          description: Repository binding deleted
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

components:
  parameters:
    ProjectID:
      in: path
      name: project_id
      required: true
      schema:
        type: string
    RunID:
      in: path
      name: run_id
      required: true
      schema:
        type: string
    UserID:
      in: path
      name: user_id
      required: true
      schema:
        type: string
    Limit:
      in: query
      name: limit
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 1000
  responses:
    BadRequest:
      description: Invalid request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Forbidden:
      description: Forbidden
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Internal:
      description: Internal error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      additionalProperties: false
      required: [code, message]
      properties:
        code:
          type: string
          enum:
            - invalid_argument
            - unauthorized
            - forbidden
            - not_found
            - conflict
            - failed_precondition
            - resource_exhausted
            - deadline_exceeded
            - unavailable
            - canceled
            - internal
        message:
          type: string
        field:
          type: string

    IngestGitHubWebhookResponse:
      type: object
      additionalProperties: false
      required: [correlation_id, status, duplicate]
      properties:
        correlation_id:
          type: string
        run_id:
          type: string
        status:
          type: string
          enum: [accepted, duplicate, ignored]
        duplicate:
          type: boolean

    MeUser:
      type: object
      additionalProperties: false
      required: [id, email, github_login, is_platform_admin, is_platform_owner]
      properties:
        id:
          type: string
        email:
          type: string
        github_login:
          type: string
        is_platform_admin:
          type: boolean
        is_platform_owner:
          type: boolean

    MeResponse:
      type: object
      additionalProperties: false
      required: [user]
      properties:
        user:
          $ref: "#/components/schemas/MeUser"

    RunNamespaceCleanupResponse:
      type: object
      additionalProperties: false
      required: [run_id, namespace, deleted, already_deleted]
      properties:
        run_id:
          type: string
        namespace:
          type: string
        deleted:
          type: boolean
        already_deleted:
          type: boolean
        comment_url:
          type: string
          nullable: true

    Project:
      type: object
      additionalProperties: false
      required: [id, slug, name, role]
      properties:
        id:
          type: string
        slug:
          type: string
        name:
          type: string
        role:
          type: string

    Run:
      type: object
      additionalProperties: false
      required:
        - id
        - correlation_id
        - project_slug
        - project_name
        - status
        - created_at
      properties:
        id:
          type: string
        correlation_id:
          type: string
        project_id:
          type: string
          nullable: true
        project_slug:
          type: string
        project_name:
          type: string
        status:
          type: string
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        finished_at:
          type: string
          format: date-time
          nullable: true

    FlowEvent:
      type: object
      additionalProperties: false
      required: [correlation_id, event_type, created_at, payload_json]
      properties:
        correlation_id:
          type: string
        event_type:
          type: string
        created_at:
          type: string
          format: date-time
        payload_json:
          type: string

    LearningFeedback:
      type: object
      additionalProperties: false
      required: [id, run_id, kind, explanation, created_at]
      properties:
        id:
          type: integer
          format: int64
        run_id:
          type: string
        repository_id:
          type: string
          nullable: true
        pr_number:
          type: integer
          format: int32
          nullable: true
        file_path:
          type: string
          nullable: true
        line:
          type: integer
          format: int32
          nullable: true
        kind:
          type: string
        explanation:
          type: string
        created_at:
          type: string
          format: date-time

    User:
      type: object
      additionalProperties: false
      required: [id, email, is_platform_admin, is_platform_owner]
      properties:
        id:
          type: string
        email:
          type: string
        github_user_id:
          type: integer
          format: int64
          nullable: true
        github_login:
          type: string
          nullable: true
        is_platform_admin:
          type: boolean
        is_platform_owner:
          type: boolean

    ProjectMember:
      type: object
      additionalProperties: false
      required: [project_id, user_id, email, role]
      properties:
        project_id:
          type: string
        user_id:
          type: string
        email:
          type: string
        role:
          type: string
          enum: [read, read_write, admin]
        learning_mode_override:
          type: boolean
          nullable: true

    RepositoryBinding:
      type: object
      additionalProperties: false
      required: [id, project_id, provider, external_id, owner, name, services_yaml_path]
      properties:
        id:
          type: string
        project_id:
          type: string
        provider:
          type: string
        external_id:
          type: integer
          format: int64
        owner:
          type: string
        name:
          type: string
        services_yaml_path:
          type: string

    ProjectItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Project"

    RunItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/Run"

    FlowEventItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/FlowEvent"

    LearningFeedbackItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/LearningFeedback"

    UserItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/User"

    ProjectMemberItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/ProjectMember"

    RepositoryBindingItemsResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: "#/components/schemas/RepositoryBinding"

    UpsertProjectRequest:
      type: object
      additionalProperties: false
      required: [slug, name]
      properties:
        slug:
          type: string
          minLength: 1
        name:
          type: string
          minLength: 1

    CreateUserRequest:
      type: object
      additionalProperties: false
      required: [email, is_platform_admin]
      properties:
        email:
          type: string
          format: email
        is_platform_admin:
          type: boolean

    UpsertProjectMemberRequest:
      type: object
      additionalProperties: false
      properties:
        user_id:
          type: string
        email:
          type: string
          format: email
        role:
          type: string
          enum: [read, read_write, admin]
      oneOf:
        - required: [user_id, role]
        - required: [email, role]

    SetProjectMemberLearningModeRequest:
      type: object
      additionalProperties: false
      required: [enabled]
      properties:
        enabled:
          type: boolean
          nullable: true

    UpsertProjectRepositoryRequest:
      type: object
      additionalProperties: false
      required: [provider, owner, name, token, services_yaml_path]
      properties:
        provider:
          type: string
          minLength: 1
        owner:
          type: string
          minLength: 1
        name:
          type: string
          minLength: 1
        token:
          type: string
          minLength: 1
        services_yaml_path:
          type: string
          minLength: 1

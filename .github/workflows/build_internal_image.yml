name: "Build Internal Image (Kaniko) üê≥"

on:
  push:
    branches: [main, codex/dev]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: codex-k8s-internal-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare-registry:
    name: "Prepare in-cluster registry for Kaniko matrix build"
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Prepare registry and git token secret
        env:
          CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
          CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
          CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
          CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE || '20Gi' }}
          CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
          CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/api-gateway' }}
          CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/control-plane' }}
          CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/worker' }}
          CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/agent-runner' }}
          CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/web-console' }}
          CODEXK8S_KANIKO_TIMEOUT: ${{ vars.CODEXK8S_KANIKO_TIMEOUT || '1800s' }}
          CODEXK8S_KANIKO_CACHE_ENABLED: ${{ vars.CODEXK8S_KANIKO_CACHE_ENABLED || 'true' }}
          CODEXK8S_KANIKO_CACHE_REPO: ${{ vars.CODEXK8S_KANIKO_CACHE_REPO || '' }}
          CODEXK8S_KANIKO_CACHE_TTL: ${{ vars.CODEXK8S_KANIKO_CACHE_TTL || '168h' }}
          CODEXK8S_KANIKO_CACHE_COMPRESSED: ${{ vars.CODEXK8S_KANIKO_CACHE_COMPRESSED || 'false' }}
          CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU || '8' }}
          CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY || '16Gi' }}
          CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU || '16' }}
          CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY || '32Gi' }}
          CODEXK8S_GITHUB_REPO: ${{ github.repository }}
          CODEXK8S_GITHUB_PAT: ${{ secrets.CODEXK8S_GITHUB_PAT }}
          CODEXK8S_BUILD_REF: ${{ github.sha }}
          CODEXK8S_PREPARE_ONLY: "true"
          CODEXK8S_ENSURE_REGISTRY: "true"
          CODEXK8S_BUILD_COMPONENTS: "api-gateway"
        run: |
          set -euo pipefail
          bash deploy/scripts/build_internal_image.sh

  build-and-push:
    name: "Build and Push image (${{ matrix.component }}) to in-cluster registry"
    needs: [prepare-registry]
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJSON(vars.CODEXK8S_KANIKO_MATRIX_MAX_PARALLEL || '4') }}
      matrix:
        component: [api-gateway, control-plane, worker, agent-runner, web-console]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Build image via Kaniko (no-registry-auth mode)
        env:
          CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
          CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
          CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
          CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE || '20Gi' }}
          CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
          CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/api-gateway' }}
          CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/control-plane' }}
          CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/worker' }}
          CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_AGENT_RUNNER_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/agent-runner' }}
          CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/web-console' }}
          CODEXK8S_KANIKO_TIMEOUT: ${{ vars.CODEXK8S_KANIKO_TIMEOUT || '1800s' }}
          CODEXK8S_KANIKO_CACHE_ENABLED: ${{ vars.CODEXK8S_KANIKO_CACHE_ENABLED || 'true' }}
          CODEXK8S_KANIKO_CACHE_REPO: ${{ vars.CODEXK8S_KANIKO_CACHE_REPO || '' }}
          CODEXK8S_KANIKO_CACHE_TTL: ${{ vars.CODEXK8S_KANIKO_CACHE_TTL || '168h' }}
          CODEXK8S_KANIKO_CACHE_COMPRESSED: ${{ vars.CODEXK8S_KANIKO_CACHE_COMPRESSED || 'false' }}
          CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU || '8' }}
          CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY || '16Gi' }}
          CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU || '16' }}
          CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY || '32Gi' }}
          CODEXK8S_GITHUB_REPO: ${{ github.repository }}
          CODEXK8S_GITHUB_PAT: ${{ secrets.CODEXK8S_GITHUB_PAT }}
          CODEXK8S_BUILD_REF: ${{ github.sha }}
          CODEXK8S_PREPARE_ONLY: "false"
          CODEXK8S_ENSURE_REGISTRY: "false"
          CODEXK8S_BUILD_COMPONENTS: ${{ matrix.component }}
        run: |
          set -euo pipefail
          bash deploy/scripts/build_internal_image.sh

  deploy-staging:
    name: "Deploy codex-k8s to ai-staging (after build on codex/dev)"
    needs: [build-and-push]
    if: ${{ github.ref == 'refs/heads/codex/dev' }}
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    environment: ai-staging
    env:
      CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
      CODEXK8S_STAGING_DOMAIN: ${{ vars.CODEXK8S_STAGING_DOMAIN }}
      CODEXK8S_API_GATEWAY_IMAGE: ${{ vars.CODEXK8S_API_GATEWAY_IMAGE || '127.0.0.1:5000/codex-k8s/api-gateway:latest' }}
      CODEXK8S_CONTROL_PLANE_IMAGE: ${{ vars.CODEXK8S_CONTROL_PLANE_IMAGE || '127.0.0.1:5000/codex-k8s/control-plane:latest' }}
      CODEXK8S_WORKER_IMAGE: ${{ vars.CODEXK8S_WORKER_IMAGE || '127.0.0.1:5000/codex-k8s/worker:latest' }}
      CODEXK8S_AGENT_RUNNER_IMAGE: ${{ vars.CODEXK8S_AGENT_RUNNER_IMAGE || '127.0.0.1:5000/codex-k8s/agent-runner:latest' }}
      CODEXK8S_WEB_CONSOLE_IMAGE: ${{ vars.CODEXK8S_WEB_CONSOLE_IMAGE || '127.0.0.1:5000/codex-k8s/web-console:latest' }}
      CODEXK8S_K8S_API_CIDR: ${{ vars.CODEXK8S_K8S_API_CIDR || '0.0.0.0/0' }}
      CODEXK8S_K8S_API_PORT: ${{ vars.CODEXK8S_K8S_API_PORT || '6443' }}
      CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
      CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
      CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
      CODEXK8S_WAIT_ROLLOUT: ${{ vars.CODEXK8S_WAIT_ROLLOUT || 'true' }}
      CODEXK8S_ROLLOUT_TIMEOUT: ${{ vars.CODEXK8S_ROLLOUT_TIMEOUT || '1800s' }}
      CODEXK8S_WORKER_REPLICAS: ${{ vars.CODEXK8S_WORKER_REPLICAS || '1' }}
      CODEXK8S_WORKER_POLL_INTERVAL: ${{ vars.CODEXK8S_WORKER_POLL_INTERVAL || '5s' }}
      CODEXK8S_WORKER_CLAIM_LIMIT: ${{ vars.CODEXK8S_WORKER_CLAIM_LIMIT || '2' }}
      CODEXK8S_WORKER_RUNNING_CHECK_LIMIT: ${{ vars.CODEXK8S_WORKER_RUNNING_CHECK_LIMIT || '200' }}
      CODEXK8S_WORKER_SLOTS_PER_PROJECT: ${{ vars.CODEXK8S_WORKER_SLOTS_PER_PROJECT || '2' }}
      CODEXK8S_WORKER_SLOT_LEASE_TTL: ${{ vars.CODEXK8S_WORKER_SLOT_LEASE_TTL || '10m' }}
      CODEXK8S_WORKER_K8S_NAMESPACE: ${{ vars.CODEXK8S_WORKER_K8S_NAMESPACE || vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
      CODEXK8S_WORKER_JOB_IMAGE: ${{ vars.CODEXK8S_WORKER_JOB_IMAGE || vars.CODEXK8S_AGENT_RUNNER_IMAGE || '127.0.0.1:5000/codex-k8s/agent-runner:latest' }}
      CODEXK8S_WORKER_JOB_COMMAND: ${{ vars.CODEXK8S_WORKER_JOB_COMMAND || '/usr/local/bin/codex-k8s-agent-runner' }}
      CODEXK8S_WORKER_JOB_TTL_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_TTL_SECONDS || '600' }}
      CODEXK8S_WORKER_JOB_BACKOFF_LIMIT: ${{ vars.CODEXK8S_WORKER_JOB_BACKOFF_LIMIT || '0' }}
      CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS || '900' }}
      CODEXK8S_WORKER_RUN_NAMESPACE_PREFIX: ${{ vars.CODEXK8S_WORKER_RUN_NAMESPACE_PREFIX || 'codex-issue' }}
      CODEXK8S_WORKER_RUN_NAMESPACE_CLEANUP: ${{ vars.CODEXK8S_WORKER_RUN_NAMESPACE_CLEANUP || 'true' }}
      CODEXK8S_WORKER_RUN_SERVICE_ACCOUNT: ${{ vars.CODEXK8S_WORKER_RUN_SERVICE_ACCOUNT || 'codex-runner' }}
      CODEXK8S_WORKER_RUN_ROLE_NAME: ${{ vars.CODEXK8S_WORKER_RUN_ROLE_NAME || 'codex-runner' }}
      CODEXK8S_WORKER_RUN_ROLE_BINDING_NAME: ${{ vars.CODEXK8S_WORKER_RUN_ROLE_BINDING_NAME || 'codex-runner' }}
      CODEXK8S_WORKER_RUN_RESOURCE_QUOTA_NAME: ${{ vars.CODEXK8S_WORKER_RUN_RESOURCE_QUOTA_NAME || 'codex-run-quota' }}
      CODEXK8S_WORKER_RUN_LIMIT_RANGE_NAME: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_RANGE_NAME || 'codex-run-limits' }}
      CODEXK8S_WORKER_RUN_CREDENTIALS_SECRET_NAME: ${{ vars.CODEXK8S_WORKER_RUN_CREDENTIALS_SECRET_NAME || 'codex-run-credentials' }}
      CODEXK8S_WORKER_RUN_QUOTA_PODS: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_PODS || '20' }}
      CODEXK8S_WORKER_RUN_QUOTA_REQUESTS_CPU: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_REQUESTS_CPU || '4' }}
      CODEXK8S_WORKER_RUN_QUOTA_REQUESTS_MEMORY: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_REQUESTS_MEMORY || '8Gi' }}
      CODEXK8S_WORKER_RUN_QUOTA_LIMITS_CPU: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_LIMITS_CPU || '8' }}
      CODEXK8S_WORKER_RUN_QUOTA_LIMITS_MEMORY: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_LIMITS_MEMORY || '16Gi' }}
      CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_REQUEST_CPU: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_REQUEST_CPU || '250m' }}
      CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_REQUEST_MEMORY: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_REQUEST_MEMORY || '256Mi' }}
      CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_CPU: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_CPU || '1' }}
      CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_MEMORY: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_DEFAULT_MEMORY || '1Gi' }}
      CODEXK8S_CONTROL_PLANE_GRPC_TARGET: ${{ vars.CODEXK8S_CONTROL_PLANE_GRPC_TARGET || '' }}
      CODEXK8S_CONTROL_PLANE_MCP_BASE_URL: ${{ vars.CODEXK8S_CONTROL_PLANE_MCP_BASE_URL || '' }}
      CODEXK8S_AGENT_DEFAULT_MODEL: ${{ vars.CODEXK8S_AGENT_DEFAULT_MODEL || 'gpt-5-codex' }}
      CODEXK8S_AGENT_DEFAULT_REASONING_EFFORT: ${{ vars.CODEXK8S_AGENT_DEFAULT_REASONING_EFFORT || 'high' }}
      CODEXK8S_AGENT_DEFAULT_LOCALE: ${{ vars.CODEXK8S_AGENT_DEFAULT_LOCALE || 'ru' }}
      CODEXK8S_AGENT_BASE_BRANCH: ${{ vars.CODEXK8S_AGENT_BASE_BRANCH || 'main' }}
      CODEXK8S_GIT_BOT_USERNAME: ${{ vars.CODEXK8S_GIT_BOT_USERNAME || '' }}
      CODEXK8S_GIT_BOT_MAIL: ${{ vars.CODEXK8S_GIT_BOT_MAIL || '' }}
      CODEXK8S_MCP_TOKEN_TTL: ${{ vars.CODEXK8S_MCP_TOKEN_TTL || '24h' }}
      CODEXK8S_API_GATEWAY_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_API_GATEWAY_RESOURCES_REQUEST_CPU || '100m' }}
      CODEXK8S_API_GATEWAY_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_API_GATEWAY_RESOURCES_REQUEST_MEMORY || '256Mi' }}
      CODEXK8S_API_GATEWAY_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_API_GATEWAY_RESOURCES_LIMIT_CPU || '1000m' }}
      CODEXK8S_API_GATEWAY_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_API_GATEWAY_RESOURCES_LIMIT_MEMORY || '1Gi' }}
      CODEXK8S_CONTROL_PLANE_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_CONTROL_PLANE_RESOURCES_REQUEST_CPU || '100m' }}
      CODEXK8S_CONTROL_PLANE_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_CONTROL_PLANE_RESOURCES_REQUEST_MEMORY || '256Mi' }}
      CODEXK8S_CONTROL_PLANE_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_CONTROL_PLANE_RESOURCES_LIMIT_CPU || '1000m' }}
      CODEXK8S_CONTROL_PLANE_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_CONTROL_PLANE_RESOURCES_LIMIT_MEMORY || '1Gi' }}
      CODEXK8S_WORKER_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_WORKER_RESOURCES_REQUEST_CPU || '100m' }}
      CODEXK8S_WORKER_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_WORKER_RESOURCES_REQUEST_MEMORY || '256Mi' }}
      CODEXK8S_WORKER_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_WORKER_RESOURCES_LIMIT_CPU || '1000m' }}
      CODEXK8S_WORKER_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_WORKER_RESOURCES_LIMIT_MEMORY || '1Gi' }}
      CODEXK8S_WEB_CONSOLE_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_WEB_CONSOLE_RESOURCES_REQUEST_CPU || '100m' }}
      CODEXK8S_WEB_CONSOLE_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_WEB_CONSOLE_RESOURCES_REQUEST_MEMORY || '128Mi' }}
      CODEXK8S_WEB_CONSOLE_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_WEB_CONSOLE_RESOURCES_LIMIT_CPU || '500m' }}
      CODEXK8S_WEB_CONSOLE_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_WEB_CONSOLE_RESOURCES_LIMIT_MEMORY || '512Mi' }}
      CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_CPU || '8' }}
      CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_REQUEST_MEMORY || '16Gi' }}
      CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_CPU || '16' }}
      CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY: ${{ vars.CODEXK8S_KANIKO_RESOURCES_LIMIT_MEMORY || '32Gi' }}
      CODEXK8S_KANIKO_CACHE_ENABLED: ${{ vars.CODEXK8S_KANIKO_CACHE_ENABLED || 'true' }}
      CODEXK8S_KANIKO_CACHE_REPO: ${{ vars.CODEXK8S_KANIKO_CACHE_REPO || '' }}
      CODEXK8S_KANIKO_CACHE_TTL: ${{ vars.CODEXK8S_KANIKO_CACHE_TTL || '168h' }}
      CODEXK8S_KANIKO_CACHE_COMPRESSED: ${{ vars.CODEXK8S_KANIKO_CACHE_COMPRESSED || 'false' }}
      CODEXK8S_KANIKO_MATRIX_MAX_PARALLEL: ${{ vars.CODEXK8S_KANIKO_MATRIX_MAX_PARALLEL || '4' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Apply staging manifests
        env:
          CODEXK8S_OPENAI_API_KEY: ${{ secrets.CODEXK8S_OPENAI_API_KEY }}
          CODEXK8S_GIT_BOT_TOKEN: ${{ secrets.CODEXK8S_GIT_BOT_TOKEN }}
          CODEXK8S_CONTEXT7_API_KEY: ${{ secrets.CODEXK8S_CONTEXT7_API_KEY }}
          CODEXK8S_POSTGRES_DB: ${{ vars.CODEXK8S_POSTGRES_DB || 'codex_k8s' }}
          CODEXK8S_POSTGRES_USER: ${{ vars.CODEXK8S_POSTGRES_USER || 'codex_k8s' }}
          CODEXK8S_POSTGRES_PASSWORD: ${{ secrets.CODEXK8S_POSTGRES_PASSWORD }}
          CODEXK8S_APP_SECRET_KEY: ${{ secrets.CODEXK8S_APP_SECRET_KEY }}
          CODEXK8S_TOKEN_ENCRYPTION_KEY: ${{ secrets.CODEXK8S_TOKEN_ENCRYPTION_KEY }}
          CODEXK8S_MCP_TOKEN_SIGNING_KEY: ${{ secrets.CODEXK8S_MCP_TOKEN_SIGNING_KEY || '' }}
          CODEXK8S_MCP_TOKEN_TTL: ${{ vars.CODEXK8S_MCP_TOKEN_TTL || '24h' }}
          CODEXK8S_GITHUB_WEBHOOK_SECRET: ${{ secrets.CODEXK8S_GITHUB_WEBHOOK_SECRET }}
          CODEXK8S_PUBLIC_BASE_URL: ${{ vars.CODEXK8S_PUBLIC_BASE_URL }}
          CODEXK8S_BOOTSTRAP_OWNER_EMAIL: ${{ vars.CODEXK8S_BOOTSTRAP_OWNER_EMAIL }}
          CODEXK8S_BOOTSTRAP_ALLOWED_EMAILS: ${{ vars.CODEXK8S_BOOTSTRAP_ALLOWED_EMAILS || '' }}
          CODEXK8S_BOOTSTRAP_PLATFORM_ADMIN_EMAILS: ${{ vars.CODEXK8S_BOOTSTRAP_PLATFORM_ADMIN_EMAILS || '' }}
          CODEXK8S_LEARNING_MODE_DEFAULT: ${{ vars.CODEXK8S_LEARNING_MODE_DEFAULT || '' }}
          CODEXK8S_GITHUB_WEBHOOK_URL: ${{ vars.CODEXK8S_GITHUB_WEBHOOK_URL || '' }}
          CODEXK8S_GITHUB_WEBHOOK_EVENTS: ${{ vars.CODEXK8S_GITHUB_WEBHOOK_EVENTS || '' }}
          CODEXK8S_GITHUB_OAUTH_CLIENT_ID: ${{ vars.CODEXK8S_GITHUB_OAUTH_CLIENT_ID }}
          CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET: ${{ secrets.CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET }}
          CODEXK8S_JWT_SIGNING_KEY: ${{ secrets.CODEXK8S_JWT_SIGNING_KEY }}
          CODEXK8S_JWT_TTL: ${{ vars.CODEXK8S_JWT_TTL || '15m' }}
          CODEXK8S_RUN_DEV_LABEL: ${{ vars.RUN_DEV_LABEL || 'run:dev' }}
          CODEXK8S_RUN_DEV_REVISE_LABEL: ${{ vars.RUN_DEV_REVISE_LABEL || 'run:dev:revise' }}
          CODEXK8S_RUN_DEBUG_LABEL: ${{ vars.RUN_DEBUG_LABEL || 'run:debug' }}
          CODEXK8S_WEB_CONSOLE_IMAGE: ${{ vars.CODEXK8S_WEB_CONSOLE_IMAGE || '127.0.0.1:5000/codex-k8s/web-console:latest' }}
        run: |
          set -euo pipefail
          bash deploy/scripts/deploy_staging.sh

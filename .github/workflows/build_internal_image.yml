name: "Build Internal Image (Kaniko) üê≥"

on:
  push:
    branches: [main, codex/dev]
    tags:
      - "v*"
  workflow_dispatch:

concurrency:
  group: codex-k8s-internal-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-push:
    name: "Build and Push image to in-cluster registry"
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Build image via Kaniko (no-registry-auth mode)
        env:
          CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
          CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
          CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
          CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_STORAGE_SIZE || '20Gi' }}
          CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
          CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_API_GATEWAY_INTERNAL_IMAGE_REPOSITORY || vars.CODEXK8S_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/api-gateway' }}
          CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_CONTROL_PLANE_INTERNAL_IMAGE_REPOSITORY || vars.CODEXK8S_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/control-plane' }}
          CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WORKER_INTERNAL_IMAGE_REPOSITORY || vars.CODEXK8S_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/worker' }}
          CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_WEB_CONSOLE_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/web-console' }}
          CODEXK8S_KANIKO_TIMEOUT: ${{ vars.CODEXK8S_KANIKO_TIMEOUT || '1800s' }}
          CODEXK8S_GITHUB_REPO: ${{ github.repository }}
          CODEXK8S_GITHUB_PAT: ${{ secrets.CODEXK8S_GITHUB_PAT }}
          CODEXK8S_BUILD_REF: ${{ github.sha }}
        run: |
          set -euo pipefail
          bash deploy/scripts/build_internal_image.sh

name: "AI Staging deploy üöÄ"

on:
  workflow_run:
    workflows: ["Build and Push GHCR üê≥"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

env:
  STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
  STAGING_DOMAIN: ${{ vars.CODEXK8S_STAGING_DOMAIN || '' }}
  CODEXK8S_IMAGE: ${{ vars.CODEXK8S_IMAGE || 'ghcr.io/codex-k8s/codex-k8s:latest' }}
  CODEXK8S_WAIT_ROLLOUT: ${{ vars.CODEXK8S_WAIT_ROLLOUT || 'false' }}

concurrency:
  group: codex-k8s-staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy codex-k8s to ai-staging"
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    environment: ai-staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Apply staging manifests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CONTEXT7_API_KEY: ${{ secrets.CONTEXT7_API_KEY }}
          POSTGRES_DB: ${{ vars.CODEXK8S_POSTGRES_DB || 'codex_k8s' }}
          POSTGRES_USER: ${{ vars.CODEXK8S_POSTGRES_USER || 'codex_k8s' }}
          POSTGRES_PASSWORD: ${{ secrets.CODEXK8S_POSTGRES_PASSWORD }}
          APP_SECRET_KEY: ${{ secrets.CODEXK8S_APP_SECRET_KEY }}
          TOKEN_ENCRYPTION_KEY: ${{ secrets.CODEXK8S_TOKEN_ENCRYPTION_KEY }}
        run: |
          set -euo pipefail
          bash deploy/scripts/deploy_staging.sh

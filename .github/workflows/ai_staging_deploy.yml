name: "AI Staging deploy üöÄ"

on:
  workflow_run:
    workflows: ["Build Internal Image (Kaniko) üê≥"]
    branches: [main]
    types: [completed]
  workflow_dispatch:

env:
  CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
  CODEXK8S_STAGING_DOMAIN: ${{ vars.CODEXK8S_STAGING_DOMAIN }}
  CODEXK8S_IMAGE: ${{ vars.CODEXK8S_IMAGE }}
  CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
  CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
  CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
  CODEXK8S_INTERNAL_IMAGE_REPOSITORY: ${{ vars.CODEXK8S_INTERNAL_IMAGE_REPOSITORY || 'codex-k8s/codex-k8s' }}
  CODEXK8S_WAIT_ROLLOUT: ${{ vars.CODEXK8S_WAIT_ROLLOUT || 'true' }}
  CODEXK8S_ROLLOUT_TIMEOUT: ${{ vars.CODEXK8S_ROLLOUT_TIMEOUT || '1800s' }}
  CODEXK8S_WORKER_REPLICAS: ${{ vars.CODEXK8S_WORKER_REPLICAS || '1' }}
  CODEXK8S_WORKER_POLL_INTERVAL: ${{ vars.CODEXK8S_WORKER_POLL_INTERVAL || '5s' }}
  CODEXK8S_WORKER_CLAIM_LIMIT: ${{ vars.CODEXK8S_WORKER_CLAIM_LIMIT || '2' }}
  CODEXK8S_WORKER_RUNNING_CHECK_LIMIT: ${{ vars.CODEXK8S_WORKER_RUNNING_CHECK_LIMIT || '200' }}
  CODEXK8S_WORKER_SLOTS_PER_PROJECT: ${{ vars.CODEXK8S_WORKER_SLOTS_PER_PROJECT || '2' }}
  CODEXK8S_WORKER_SLOT_LEASE_TTL: ${{ vars.CODEXK8S_WORKER_SLOT_LEASE_TTL || '10m' }}
  CODEXK8S_WORKER_K8S_NAMESPACE: ${{ vars.CODEXK8S_WORKER_K8S_NAMESPACE || vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
  CODEXK8S_WORKER_JOB_IMAGE: ${{ vars.CODEXK8S_WORKER_JOB_IMAGE || vars.CODEXK8S_IMAGE || '127.0.0.1:5000/codex-k8s/codex-k8s:latest' }}
  CODEXK8S_WORKER_JOB_COMMAND: ${{ vars.CODEXK8S_WORKER_JOB_COMMAND || 'echo codex-k8s run; sleep 2' }}
  CODEXK8S_WORKER_JOB_TTL_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_TTL_SECONDS || '600' }}
  CODEXK8S_WORKER_JOB_BACKOFF_LIMIT: ${{ vars.CODEXK8S_WORKER_JOB_BACKOFF_LIMIT || '0' }}
  CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS || '900' }}

concurrency:
  group: codex-k8s-staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy codex-k8s to ai-staging"
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    environment: ai-staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Apply staging manifests
        env:
          CODEXK8S_OPENAI_API_KEY: ${{ secrets.CODEXK8S_OPENAI_API_KEY }}
          CODEXK8S_CONTEXT7_API_KEY: ${{ secrets.CODEXK8S_CONTEXT7_API_KEY }}
          CODEXK8S_POSTGRES_DB: ${{ vars.CODEXK8S_POSTGRES_DB || 'codex_k8s' }}
          CODEXK8S_POSTGRES_USER: ${{ vars.CODEXK8S_POSTGRES_USER || 'codex_k8s' }}
          CODEXK8S_POSTGRES_PASSWORD: ${{ secrets.CODEXK8S_POSTGRES_PASSWORD }}
          CODEXK8S_APP_SECRET_KEY: ${{ secrets.CODEXK8S_APP_SECRET_KEY }}
          CODEXK8S_TOKEN_ENCRYPTION_KEY: ${{ secrets.CODEXK8S_TOKEN_ENCRYPTION_KEY }}
          CODEXK8S_GITHUB_WEBHOOK_SECRET: ${{ secrets.CODEXK8S_GITHUB_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          bash deploy/scripts/deploy_staging.sh

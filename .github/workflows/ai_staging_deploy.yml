name: "AI Staging deploy ðŸš€"

on:
  workflow_dispatch:

env:
  CODEXK8S_STAGING_NAMESPACE: ${{ vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
  CODEXK8S_STAGING_DOMAIN: ${{ vars.CODEXK8S_STAGING_DOMAIN }}
  CODEXK8S_API_GATEWAY_IMAGE: ${{ vars.CODEXK8S_API_GATEWAY_IMAGE || '127.0.0.1:5000/codex-k8s/api-gateway:latest' }}
  CODEXK8S_CONTROL_PLANE_IMAGE: ${{ vars.CODEXK8S_CONTROL_PLANE_IMAGE || '127.0.0.1:5000/codex-k8s/control-plane:latest' }}
  CODEXK8S_WORKER_IMAGE: ${{ vars.CODEXK8S_WORKER_IMAGE || '127.0.0.1:5000/codex-k8s/worker:latest' }}
  CODEXK8S_AGENT_RUNNER_IMAGE: ${{ vars.CODEXK8S_AGENT_RUNNER_IMAGE || '127.0.0.1:5000/codex-k8s/agent-runner:latest' }}
  CODEXK8S_WEB_CONSOLE_IMAGE: ${{ vars.CODEXK8S_WEB_CONSOLE_IMAGE || '127.0.0.1:5000/codex-k8s/web-console:latest' }}
  CODEXK8S_K8S_API_CIDR: ${{ vars.CODEXK8S_K8S_API_CIDR || '0.0.0.0/0' }}
  CODEXK8S_K8S_API_PORT: ${{ vars.CODEXK8S_K8S_API_PORT || '6443' }}
  CODEXK8S_INTERNAL_REGISTRY_SERVICE: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_SERVICE || 'codex-k8s-registry' }}
  CODEXK8S_INTERNAL_REGISTRY_PORT: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_PORT || '5000' }}
  CODEXK8S_INTERNAL_REGISTRY_HOST: ${{ vars.CODEXK8S_INTERNAL_REGISTRY_HOST || '127.0.0.1:5000' }}
  CODEXK8S_WAIT_ROLLOUT: ${{ vars.CODEXK8S_WAIT_ROLLOUT || 'true' }}
  CODEXK8S_ROLLOUT_TIMEOUT: ${{ vars.CODEXK8S_ROLLOUT_TIMEOUT || '1800s' }}
  CODEXK8S_WORKER_REPLICAS: ${{ vars.CODEXK8S_WORKER_REPLICAS || '1' }}
  CODEXK8S_WORKER_POLL_INTERVAL: ${{ vars.CODEXK8S_WORKER_POLL_INTERVAL || '5s' }}
  CODEXK8S_WORKER_CLAIM_LIMIT: ${{ vars.CODEXK8S_WORKER_CLAIM_LIMIT || '2' }}
  CODEXK8S_WORKER_RUNNING_CHECK_LIMIT: ${{ vars.CODEXK8S_WORKER_RUNNING_CHECK_LIMIT || '200' }}
  CODEXK8S_WORKER_SLOTS_PER_PROJECT: ${{ vars.CODEXK8S_WORKER_SLOTS_PER_PROJECT || '2' }}
  CODEXK8S_WORKER_SLOT_LEASE_TTL: ${{ vars.CODEXK8S_WORKER_SLOT_LEASE_TTL || '10m' }}
  CODEXK8S_WORKER_K8S_NAMESPACE: ${{ vars.CODEXK8S_WORKER_K8S_NAMESPACE || vars.CODEXK8S_STAGING_NAMESPACE || 'codex-k8s-ai-staging' }}
  CODEXK8S_WORKER_JOB_IMAGE: ${{ vars.CODEXK8S_WORKER_JOB_IMAGE || vars.CODEXK8S_AGENT_RUNNER_IMAGE || '127.0.0.1:5000/codex-k8s/agent-runner:latest' }}
  CODEXK8S_WORKER_JOB_COMMAND: ${{ vars.CODEXK8S_WORKER_JOB_COMMAND || '/usr/local/bin/codex-k8s-agent-runner' }}
  CODEXK8S_WORKER_JOB_TTL_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_TTL_SECONDS || '600' }}
  CODEXK8S_WORKER_JOB_BACKOFF_LIMIT: ${{ vars.CODEXK8S_WORKER_JOB_BACKOFF_LIMIT || '0' }}
  CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS: ${{ vars.CODEXK8S_WORKER_JOB_ACTIVE_DEADLINE_SECONDS || '900' }}
  CODEXK8S_WORKER_RUN_NAMESPACE_PREFIX: ${{ vars.CODEXK8S_WORKER_RUN_NAMESPACE_PREFIX || 'codex-issue' }}
  CODEXK8S_WORKER_RUN_NAMESPACE_CLEANUP: ${{ vars.CODEXK8S_WORKER_RUN_NAMESPACE_CLEANUP || 'true' }}
  CODEXK8S_WORKER_RUN_SERVICE_ACCOUNT: ${{ vars.CODEXK8S_WORKER_RUN_SERVICE_ACCOUNT || 'codex-runner' }}
  CODEXK8S_WORKER_RUN_ROLE_NAME: ${{ vars.CODEXK8S_WORKER_RUN_ROLE_NAME || 'codex-runner' }}
  CODEXK8S_WORKER_RUN_ROLE_BINDING_NAME: ${{ vars.CODEXK8S_WORKER_RUN_ROLE_BINDING_NAME || 'codex-runner' }}
  CODEXK8S_WORKER_RUN_RESOURCE_QUOTA_NAME: ${{ vars.CODEXK8S_WORKER_RUN_RESOURCE_QUOTA_NAME || 'codex-run-quota' }}
  CODEXK8S_WORKER_RUN_LIMIT_RANGE_NAME: ${{ vars.CODEXK8S_WORKER_RUN_LIMIT_RANGE_NAME || 'codex-run-limits' }}
  CODEXK8S_WORKER_RUN_CREDENTIALS_SECRET_NAME: ${{ vars.CODEXK8S_WORKER_RUN_CREDENTIALS_SECRET_NAME || 'codex-run-credentials' }}
  CODEXK8S_WORKER_RUN_QUOTA_PODS: ${{ vars.CODEXK8S_WORKER_RUN_QUOTA_PODS || '20' }}
  CODEXK8S_CONTROL_PLANE_GRPC_TARGET: ${{ vars.CODEXK8S_CONTROL_PLANE_GRPC_TARGET || '' }}
  CODEXK8S_CONTROL_PLANE_MCP_BASE_URL: ${{ vars.CODEXK8S_CONTROL_PLANE_MCP_BASE_URL || '' }}
  CODEXK8S_AGENT_DEFAULT_MODEL: ${{ vars.CODEXK8S_AGENT_DEFAULT_MODEL || 'gpt-5.3-codex' }}
  CODEXK8S_AGENT_DEFAULT_REASONING_EFFORT: ${{ vars.CODEXK8S_AGENT_DEFAULT_REASONING_EFFORT || 'high' }}
  CODEXK8S_AGENT_DEFAULT_LOCALE: ${{ vars.CODEXK8S_AGENT_DEFAULT_LOCALE || 'ru' }}
  CODEXK8S_AGENT_BASE_BRANCH: ${{ vars.CODEXK8S_AGENT_BASE_BRANCH || 'main' }}
  CODEXK8S_AI_MODEL_GPT_5_3_CODEX_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_3_CODEX_LABEL || '[ai-model-gpt-5.3-codex]' }}
  CODEXK8S_AI_MODEL_GPT_5_3_CODEX_SPARK_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_3_CODEX_SPARK_LABEL || '[ai-model-gpt-5.3-codex-spark]' }}
  CODEXK8S_AI_MODEL_GPT_5_2_CODEX_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_2_CODEX_LABEL || '[ai-model-gpt-5.2-codex]' }}
  CODEXK8S_AI_MODEL_GPT_5_1_CODEX_MAX_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_1_CODEX_MAX_LABEL || '[ai-model-gpt-5.1-codex-max]' }}
  CODEXK8S_AI_MODEL_GPT_5_2_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_2_LABEL || '[ai-model-gpt-5.2]' }}
  CODEXK8S_AI_MODEL_GPT_5_1_CODEX_MINI_LABEL: ${{ vars.CODEXK8S_AI_MODEL_GPT_5_1_CODEX_MINI_LABEL || '[ai-model-gpt-5.1-codex-mini]' }}
  CODEXK8S_AI_REASONING_LOW_LABEL: ${{ vars.CODEXK8S_AI_REASONING_LOW_LABEL || '[ai-reasoning-low]' }}
  CODEXK8S_AI_REASONING_MEDIUM_LABEL: ${{ vars.CODEXK8S_AI_REASONING_MEDIUM_LABEL || '[ai-reasoning-medium]' }}
  CODEXK8S_AI_REASONING_HIGH_LABEL: ${{ vars.CODEXK8S_AI_REASONING_HIGH_LABEL || '[ai-reasoning-high]' }}
  CODEXK8S_AI_REASONING_EXTRA_HIGH_LABEL: ${{ vars.CODEXK8S_AI_REASONING_EXTRA_HIGH_LABEL || '[ai-reasoning-extra-high]' }}
  CODEXK8S_GIT_BOT_USERNAME: ${{ vars.CODEXK8S_GIT_BOT_USERNAME || '' }}
  CODEXK8S_GIT_BOT_MAIL: ${{ vars.CODEXK8S_GIT_BOT_MAIL || '' }}
  CODEXK8S_MCP_TOKEN_TTL: ${{ vars.CODEXK8S_MCP_TOKEN_TTL || '24h' }}
  CODEXK8S_KANIKO_CACHE_ENABLED: ${{ vars.CODEXK8S_KANIKO_CACHE_ENABLED || 'true' }}
  CODEXK8S_KANIKO_CACHE_REPO: ${{ vars.CODEXK8S_KANIKO_CACHE_REPO || '' }}
  CODEXK8S_KANIKO_CACHE_TTL: ${{ vars.CODEXK8S_KANIKO_CACHE_TTL || '168h' }}
  CODEXK8S_KANIKO_CACHE_COMPRESSED: ${{ vars.CODEXK8S_KANIKO_CACHE_COMPRESSED || 'false' }}
  CODEXK8S_KANIKO_MATRIX_MAX_PARALLEL: ${{ vars.CODEXK8S_KANIKO_MATRIX_MAX_PARALLEL || '4' }}

concurrency:
  group: codex-k8s-staging-deploy
  cancel-in-progress: false

jobs:
  deploy:
    name: "Deploy codex-k8s to ai-staging"
    runs-on: ${{ vars.CODEXK8S_STAGING_RUNNER || 'codex-k8s-ai-staging' }}
    environment: ai-staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Apply staging manifests
        env:
          CODEXK8S_GITHUB_PAT: ${{ secrets.CODEXK8S_GITHUB_PAT }}
          CODEXK8S_OPENAI_API_KEY: ${{ secrets.CODEXK8S_OPENAI_API_KEY }}
          CODEXK8S_OPENAI_AUTH_FILE: ${{ secrets.CODEXK8S_OPENAI_AUTH_FILE || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_HOST: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_HOST || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_PORT: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_PORT || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_USER: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_USER || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_PASSWORD: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_PASSWORD || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_SSLMODE: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_SSLMODE || '' }}
          CODEXK8S_PROJECT_DB_ADMIN_DATABASE: ${{ secrets.CODEXK8S_PROJECT_DB_ADMIN_DATABASE || '' }}
          CODEXK8S_PROJECT_DB_LIFECYCLE_ALLOWED_ENVS: ${{ secrets.CODEXK8S_PROJECT_DB_LIFECYCLE_ALLOWED_ENVS || '' }}
          CODEXK8S_GIT_BOT_TOKEN: ${{ secrets.CODEXK8S_GIT_BOT_TOKEN }}
          CODEXK8S_CONTEXT7_API_KEY: ${{ secrets.CODEXK8S_CONTEXT7_API_KEY }}
          CODEXK8S_POSTGRES_DB: ${{ vars.CODEXK8S_POSTGRES_DB || 'codex_k8s' }}
          CODEXK8S_POSTGRES_USER: ${{ vars.CODEXK8S_POSTGRES_USER || 'codex_k8s' }}
          CODEXK8S_POSTGRES_PASSWORD: ${{ secrets.CODEXK8S_POSTGRES_PASSWORD }}
          CODEXK8S_APP_SECRET_KEY: ${{ secrets.CODEXK8S_APP_SECRET_KEY }}
          CODEXK8S_TOKEN_ENCRYPTION_KEY: ${{ secrets.CODEXK8S_TOKEN_ENCRYPTION_KEY }}
          CODEXK8S_MCP_TOKEN_SIGNING_KEY: ${{ secrets.CODEXK8S_MCP_TOKEN_SIGNING_KEY || '' }}
          CODEXK8S_MCP_TOKEN_TTL: ${{ vars.CODEXK8S_MCP_TOKEN_TTL || '24h' }}
          CODEXK8S_GITHUB_WEBHOOK_SECRET: ${{ secrets.CODEXK8S_GITHUB_WEBHOOK_SECRET }}
          CODEXK8S_PUBLIC_BASE_URL: ${{ vars.CODEXK8S_PUBLIC_BASE_URL }}
          CODEXK8S_BOOTSTRAP_OWNER_EMAIL: ${{ vars.CODEXK8S_BOOTSTRAP_OWNER_EMAIL }}
          CODEXK8S_BOOTSTRAP_ALLOWED_EMAILS: ${{ vars.CODEXK8S_BOOTSTRAP_ALLOWED_EMAILS || '' }}
          CODEXK8S_BOOTSTRAP_PLATFORM_ADMIN_EMAILS: ${{ vars.CODEXK8S_BOOTSTRAP_PLATFORM_ADMIN_EMAILS || '' }}
          CODEXK8S_LEARNING_MODE_DEFAULT: ${{ vars.CODEXK8S_LEARNING_MODE_DEFAULT || '' }}
          CODEXK8S_GITHUB_WEBHOOK_URL: ${{ vars.CODEXK8S_GITHUB_WEBHOOK_URL || '' }}
          CODEXK8S_GITHUB_WEBHOOK_EVENTS: ${{ vars.CODEXK8S_GITHUB_WEBHOOK_EVENTS || '' }}
          CODEXK8S_GITHUB_OAUTH_CLIENT_ID: ${{ vars.CODEXK8S_GITHUB_OAUTH_CLIENT_ID }}
          CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET: ${{ secrets.CODEXK8S_GITHUB_OAUTH_CLIENT_SECRET }}
          CODEXK8S_JWT_SIGNING_KEY: ${{ secrets.CODEXK8S_JWT_SIGNING_KEY }}
          CODEXK8S_JWT_TTL: ${{ vars.CODEXK8S_JWT_TTL || '15m' }}
          CODEXK8S_RUN_INTAKE_LABEL: ${{ vars.CODEXK8S_RUN_INTAKE_LABEL || 'run:intake' }}
          CODEXK8S_RUN_INTAKE_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_INTAKE_REVISE_LABEL || 'run:intake:revise' }}
          CODEXK8S_RUN_VISION_LABEL: ${{ vars.CODEXK8S_RUN_VISION_LABEL || 'run:vision' }}
          CODEXK8S_RUN_VISION_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_VISION_REVISE_LABEL || 'run:vision:revise' }}
          CODEXK8S_RUN_PRD_LABEL: ${{ vars.CODEXK8S_RUN_PRD_LABEL || 'run:prd' }}
          CODEXK8S_RUN_PRD_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_PRD_REVISE_LABEL || 'run:prd:revise' }}
          CODEXK8S_RUN_ARCH_LABEL: ${{ vars.CODEXK8S_RUN_ARCH_LABEL || 'run:arch' }}
          CODEXK8S_RUN_ARCH_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_ARCH_REVISE_LABEL || 'run:arch:revise' }}
          CODEXK8S_RUN_DESIGN_LABEL: ${{ vars.CODEXK8S_RUN_DESIGN_LABEL || 'run:design' }}
          CODEXK8S_RUN_DESIGN_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_DESIGN_REVISE_LABEL || 'run:design:revise' }}
          CODEXK8S_RUN_PLAN_LABEL: ${{ vars.CODEXK8S_RUN_PLAN_LABEL || 'run:plan' }}
          CODEXK8S_RUN_PLAN_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_PLAN_REVISE_LABEL || 'run:plan:revise' }}
          CODEXK8S_RUN_DEV_LABEL: ${{ vars.CODEXK8S_RUN_DEV_LABEL || 'run:dev' }}
          CODEXK8S_RUN_DEV_REVISE_LABEL: ${{ vars.CODEXK8S_RUN_DEV_REVISE_LABEL || 'run:dev:revise' }}
          CODEXK8S_RUN_DEBUG_LABEL: ${{ vars.CODEXK8S_RUN_DEBUG_LABEL || 'run:debug' }}
          CODEXK8S_RUN_DOC_AUDIT_LABEL: ${{ vars.CODEXK8S_RUN_DOC_AUDIT_LABEL || 'run:doc-audit' }}
          CODEXK8S_RUN_QA_LABEL: ${{ vars.CODEXK8S_RUN_QA_LABEL || 'run:qa' }}
          CODEXK8S_RUN_RELEASE_LABEL: ${{ vars.CODEXK8S_RUN_RELEASE_LABEL || 'run:release' }}
          CODEXK8S_RUN_POSTDEPLOY_LABEL: ${{ vars.CODEXK8S_RUN_POSTDEPLOY_LABEL || 'run:postdeploy' }}
          CODEXK8S_RUN_OPS_LABEL: ${{ vars.CODEXK8S_RUN_OPS_LABEL || 'run:ops' }}
          CODEXK8S_RUN_SELF_IMPROVE_LABEL: ${{ vars.CODEXK8S_RUN_SELF_IMPROVE_LABEL || 'run:self-improve' }}
          CODEXK8S_RUN_RETHINK_LABEL: ${{ vars.CODEXK8S_RUN_RETHINK_LABEL || 'run:rethink' }}
          CODEXK8S_MODE_DISCUSSION_LABEL: ${{ vars.CODEXK8S_MODE_DISCUSSION_LABEL || 'mode:discussion' }}
          CODEXK8S_STATE_BLOCKED_LABEL: ${{ vars.CODEXK8S_STATE_BLOCKED_LABEL || 'state:blocked' }}
          CODEXK8S_STATE_IN_REVIEW_LABEL: ${{ vars.CODEXK8S_STATE_IN_REVIEW_LABEL || 'state:in-review' }}
          CODEXK8S_STATE_APPROVED_LABEL: ${{ vars.CODEXK8S_STATE_APPROVED_LABEL || 'state:approved' }}
          CODEXK8S_STATE_SUPERSEDED_LABEL: ${{ vars.CODEXK8S_STATE_SUPERSEDED_LABEL || 'state:superseded' }}
          CODEXK8S_STATE_ABANDONED_LABEL: ${{ vars.CODEXK8S_STATE_ABANDONED_LABEL || 'state:abandoned' }}
          CODEXK8S_NEED_INPUT_LABEL: ${{ vars.CODEXK8S_NEED_INPUT_LABEL || 'need:input' }}
          CODEXK8S_NEED_PM_LABEL: ${{ vars.CODEXK8S_NEED_PM_LABEL || 'need:pm' }}
          CODEXK8S_NEED_SA_LABEL: ${{ vars.CODEXK8S_NEED_SA_LABEL || 'need:sa' }}
          CODEXK8S_NEED_QA_LABEL: ${{ vars.CODEXK8S_NEED_QA_LABEL || 'need:qa' }}
          CODEXK8S_NEED_SRE_LABEL: ${{ vars.CODEXK8S_NEED_SRE_LABEL || 'need:sre' }}
          CODEXK8S_NEED_EM_LABEL: ${{ vars.CODEXK8S_NEED_EM_LABEL || 'need:em' }}
          CODEXK8S_NEED_KM_LABEL: ${{ vars.CODEXK8S_NEED_KM_LABEL || 'need:km' }}
          CODEXK8S_NEED_REVIEWER_LABEL: ${{ vars.CODEXK8S_NEED_REVIEWER_LABEL || 'need:reviewer' }}
          CODEXK8S_WEB_CONSOLE_IMAGE: ${{ vars.CODEXK8S_WEB_CONSOLE_IMAGE || '127.0.0.1:5000/codex-k8s/web-console:latest' }}
        run: |
          set -euo pipefail
          bash deploy/scripts/deploy_staging.sh
